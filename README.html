<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2020-06-26 Fri 12:18 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Linkage Analysis</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Mehmet Tekman" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/styles/readtheorg/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/styles/readtheorg/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/styles/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/styles/readtheorg/js/readtheorg.js"></script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2020 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Linkage Analysis</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orge8eb586">Pre-processing</a>
<ul>
<li><a href="#orgcf8c8ea">Genotyped Individuals</a>
<ul>
<li><a href="#org56e16ee">Examining the Canadian and Spanish Genotypes</a>
<ul>
<li><a href="#orgb5a9aec">Duplicate markers in any of the datasets?</a></li>
<li><a href="#orgd03e594">Overlapping markers between the sets?</a></li>
</ul>
</li>
<li><a href="#orgef3d060">Do Genotypes match between Canadian and Spanish Datasets?</a>
<ul>
<li><a href="#org5b4cdb7">Check Overlap on Datasets</a></li>
<li><a href="#orgd81eca3">Check Differences on Datasets</a></li>
</ul>
</li>
<li><a href="#org4325a52">Summary</a></li>
</ul>
</li>
<li><a href="#orgf07819c">Merging the genotypes file</a></li>
<li><a href="#orgab0352e">MAF</a></li>
<li><a href="#org00dc1be">Pedigree</a>
<ul>
<li><a href="#orgb5c16f9">Canadian</a></li>
<li><a href="#org0ca6daa">Spanish</a></li>
<li><a href="#org0509370">British</a></li>
<li><a href="#orgd3c252f">Consistency check</a></li>
</ul>
</li>
<li><a href="#orgc987f61">Map file</a>
<ul>
<li><a href="#orga632fad">Infinium Multi Ethnic Global Beadchip</a></li>
<li><a href="#org64f4a6a">Omni-X-24 BeadChip</a></li>
<li><a href="#org3ea1354">Combining Maps</a>
<ul>
<li><a href="#orgfb0e919">Intersection</a></li>
<li><a href="#org9fa21bc">Consistency check (small)</a></li>
<li><a href="#org37a09dc">Consistency check (all)</a></li>
<li><a href="#org9a30028">Examining Outliers</a></li>
<li><a href="#org295dce1">Sort the map</a></li>
<li><a href="#org5fd0626">Write the output</a></li>
</ul>
</li>
<li><a href="#orga286999">Check that the cM are in order</a></li>
<li><a href="#org408f6fb">Remove the outlier markers from the genotypes and maf file</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgc915200">Linkage Analysis (Attempts 1-3)</a>
<ul>
<li><a href="#org32c18c0">Snpbutcher</a></li>
<li><a href="#org5ca706c">Run1</a>
<ul>
<li><a href="#orga03a0c5">Issues</a>
<ul>
<li><a href="#org91e7169">Resolution</a></li>
</ul>
</li>
<li><a href="#org49b6b8c">Fixing the Input Files</a>
<ul>
<li><a href="#orgb069a1f">Fixing the Pedigree</a></li>
</ul>
</li>
<li><a href="#orgd2d65d0">Fixing the Genotypes</a></li>
<li><a href="#org6ef19fd">Generating New Map file</a></li>
</ul>
</li>
<li><a href="#org9e05c6a">Run 2</a>
<ul>
<li><a href="#orgca98010">rs211641 Error on chrX</a>
<ul>
<li><a href="#org59a1ec4">rs211641 in the pedigree 1181</a></li>
</ul>
</li>
<li><a href="#org3d3968c">Rerun without rs211641</a></li>
</ul>
</li>
<li><a href="#org92c54d2">Run 3 (without rs211641)</a>
<ul>
<li>
<ul>
<li><a href="#orgab8803f">GRR notes</a></li>
<li><a href="#org5b12ec4">rs5983047 Error on chrX</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgc01c751">Remove inconsistent X-linked Markers</a>
<ul>
<li><a href="#orgb6c9c6c">Parse the Pedigree</a></li>
<li><a href="#orgcb3f529">Parse the Genotypes</a>
<ul>
<li>
<ul>
<li><a href="#org4a5525b">Method</a></li>
<li><a href="#org3ef11f5">Test Genotypes</a></li>
<li><a href="#org17483ea">Testing On Top 10</a></li>
<li><a href="#org002ac88">Test on entire genotypes</a></li>
<li><a href="#org819c0a3">Test on Entire Genotypes (again, but this time on ChrX)</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org427e41f">Remove inconsistent X-linked Markers from genotypes</a></li>
</ul>
</li>
<li><a href="#org7e0d2f3">Linkage Analysis (Attempt 4)</a>
<ul>
<li><a href="#orgd9543fe">Snpbutcher</a></li>
<li><a href="#orged25402">Run 4: Fingers crossed</a>
<ul>
<li><a href="#org988547b">Debugging the methods again</a>
<ul>
<li><a href="#orgdb9a6d3">Methods</a></li>
</ul>
</li>
<li><a href="#orgd4c6c4a">Finding inconsistent X markers (updated)</a></li>
<li><a href="#orge60fe1f">Filtering out inconsistent markers</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org827fd0b">Linkage Analysis (Attempt 5)</a>
<ul>
<li><a href="#org8d40323">Snpbutcher</a>
<ul>
<li><a href="#orgc685cbd">Concatenate small map with full res X map</a></li>
<li><a href="#orgc47dde6">Run the Linkage</a>
<ul>
<li><a href="#org4234594">Gender error in 2024 (male by testing, female in ped)</a></li>
<li><a href="#org94ae85e">Ignoring Pedcheck</a></li>
<li><a href="#org9440a02">Success?</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#org9bd76cc">Thoughts so far</a>
<ul>
<li><a href="#orga3a9acc">Why so few markers?</a></li>
<li><a href="#org7333186">Was it just one or two individuals messing up the analysis?</a></li>
<li><a href="#org71542a5">Perhaps too stringent with the filtering?</a></li>
<li><a href="#orgf0c720a">How to proceed next</a>
<ul>
<li>
<ul>
<li><a href="#orgccd194d">Option 1: Assume chromosome X genotypes are correct and Allegro is wrong.</a></li>
<li><a href="#orgadfd17f">Option 2: Change the Gender of individual 2024 to male</a></li>
<li><a href="#org4fefd8b">Option 3: Reduce SNPButcher impact on the genotypes</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgbf76ba4">Linkage Analysis (Attempt 6)</a>
<ul>
<li>
<ul>
<li><a href="#org13271c3">Number of Possible X Markers</a></li>
<li><a href="#orgba64c76">Process Files</a></li>
<li><a href="#org2085841">Run the pipeline</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<p>
Here we try to perform linkage on three families: British, Canadian, and Spanish. The inheritance is X-recessive and so we expect a nicely defined linkage peak on the X chromosome.
</p>

<p>
Below are the steps that were performed. They are mostly notes, but I tried to expand them for clarity, and structure them to be more readable.
</p>


<div id="outline-container-orge8eb586" class="outline-2">
<h2 id="orge8eb586">Pre-processing</h2>
<div class="outline-text-2" id="text-orge8eb586">
<p>
This section deals with generating the input linkage files: Genotypes, MAF, MAP, and Pedigree
</p>
</div>

<div id="outline-container-orgcf8c8ea" class="outline-3">
<h3 id="orgcf8c8ea">Genotyped Individuals</h3>
<div class="outline-text-3" id="text-orgcf8c8ea">
<div class="org-src-container">
<pre class="src src-bash">cd ~/work/linkage/raw_copy &gt;/dev/null
head -1 Spanish/genotypes Canadian/genotypes British/genotypes
</pre>
</div>

<pre class="example">
Spanish/genotypes &lt;==
Name	2001	2002	2003	2004	2005	2006	2007	2008	2009	2010	2011	2012	2013	2014	2015	2016	2017	2018	2019	2020	2021	2022	2023	2024	2025	2026	2027	2028	2029	2030	2031	2032	2033	2034	2035	2036	2037	2038	2039	2040	2041	2042	2043	2044	2045	2046	2047	2048	2049	2050	2051	2052	2053	2054	2055	2056	2057	2058	2059	2060
Canadian/genotypes &lt;==
Name	2001	2002	2003	2004	2005	2006	2007	2008	2009	2010	2011	2012	2013	2014	2015	2016	2017	2018	2019	2020	2021	2022	2023	2024	2025	2026	2027	2028	2029	2030	2031	2032	2033	2034	2035	2036	2037	2038	2039	2040	2041	2042	2043	2044	2045	2046	2047	2048	2049	2050	2051	2052	2053	2054	2055	2056	2057	2058	2059	2060
British/genotypes &lt;==
Name	21	22	44	32	61	79	57	35	97
</pre>


<p>
It looks like Canadian and Spanish have the same set of individuals. Are the genotype files the same?
</p>
</div>


<div id="outline-container-org56e16ee" class="outline-4">
<h4 id="org56e16ee">Examining the Canadian and Spanish Genotypes</h4>
<div class="outline-text-4" id="text-org56e16ee">
<div class="org-src-container">
<pre class="src src-bash">wc -l Canadian/genotypes Spanish/genotypes | head -2
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-right">298221</td>
<td class="org-left">Canadian/genotypes</td>
</tr>

<tr>
<td class="org-right">298007</td>
<td class="org-left">Spanish/genotypes</td>
</tr>
</tbody>
</table>
</div>


<div id="outline-container-orgb5a9aec" class="outline-5">
<h5 id="orgb5a9aec">Duplicate markers in any of the datasets?</h5>
<div class="outline-text-5" id="text-orgb5a9aec">
<div class="org-src-container">
<pre class="src src-bash">cut -f1 Canadian/genotypes | sort | uniq -D
cut -f1 Spanish/genotypes | sort | uniq -D
</pre>
</div>

<p>
No duplicates.
</p>
</div>
</div>

<div id="outline-container-orgd03e594" class="outline-5">
<h5 id="orgd03e594">Overlapping markers between the sets?</h5>
<div class="outline-text-5" id="text-orgd03e594">
<div class="org-src-container">
<pre class="src src-bash">cut -f1 Canadian/genotypes Spanish/genotypes\
    | sort | uniq -c | grep ' 2 '\
    | awk '{print $2}'  | grep -v "Name" &gt; overlap.markers.canadaspain
wc -l overlap.markers.canadaspain
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-right">297712</td>
<td class="org-left">overlap.markers.canadaspain</td>
</tr>
</tbody>
</table>

<p>
A lot of overlap (99%). If we filter both the Canadian and Spanish genotypes for just the overlapping markers, are the genotypes the same?
</p>
</div>
</div>
</div>

<div id="outline-container-orgef3d060" class="outline-4">
<h4 id="orgef3d060">Do Genotypes match between Canadian and Spanish Datasets?</h4>
<div class="outline-text-4" id="text-orgef3d060">
<div class="org-src-container">
<pre class="src src-R" id="orga4446b1">#!/usr/bin/env R
tableau &lt;- function(name, ...) {
   read.table(name, stringsAsFactors=F, row.names=1, ...)
}

tab.spanish &lt;- tableau('~/work/linkage/raw_copy/Spanish/genotypes', header=T)
tab.canada &lt;- tableau('~/work/linkage/raw_copy/Canadian/genotypes', header=T)
tab.overlap &lt;- tableau('~/work/linkage/raw_copy/overlap.markers.canadaspain', header=F)
</pre>
</div>
</div>

<ul class="org-ul">
<li><a id="orged60b31"></a>Quick check for missing values<br />
<div class="outline-text-6" id="text-orged60b31">
<div class="org-src-container">
<pre class="src src-R">tab.overlap.markers &lt;- rownames(tab.overlap)
dim(tab.spanish)
dim(tab.canada)
# check for missing values
c(sum(is.na(tab.spanish)), sum(is.na(tab.canada)), sum(is.na(tab.overlap.markers)))
</pre>
</div>

<pre class="example">
[1] 298006     60
[1] 298220     60
[1] 0 0 0
</pre>


<p>
No missing values, let's overlap the datasets
</p>
</div>
</li>
</ul>


<div id="outline-container-org5b4cdb7" class="outline-5">
<h5 id="org5b4cdb7">Check Overlap on Datasets</h5>
<div class="outline-text-5" id="text-org5b4cdb7">
<div class="org-src-container">
<pre class="src src-R">tab.spanish.filt &lt;- tab.spanish[tab.overlap.markers,]
tab.canada.filt &lt;- tab.canada[tab.overlap.markers,]
dim(tab.spanish.filt)
dim(tab.canada.filt)
c(sum(is.na(tab.spanish.filt)), sum(is.na(tab.canada.filt)))
</pre>
</div>

<pre class="example">
[1] 297712     60
[1] 297712     60
[1] 0 0
</pre>


<p>
Let's check each individual across datasets and see if they're equal.
</p>

<div class="org-src-container">
<pre class="src src-R">sapply(colnames(tab.canada.filt), function(x){
    all(tab.canada.filt[,x] == tab.spanish.filt[,x])
})
</pre>
</div>

<pre class="example">
X2001 X2002 X2003 X2004 X2005 X2006 X2007 X2008 X2009 X2010 X2011 X2012 X2013
 TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE
X2014 X2015 X2016 X2017 X2018 X2019 X2020 X2021 X2022 X2023 X2024 X2025 X2026
 TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE
X2027 X2028 X2029 X2030 X2031 X2032 X2033 X2034 X2035 X2036 X2037 X2038 X2039
 TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE
X2040 X2041 X2042 X2043 X2044 X2045 X2046 X2047 X2048 X2049 X2050 X2051 X2052
 TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE
X2053 X2054 X2055 X2056 X2057 X2058 X2059 X2060
 TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE
</pre>

<p>
So for our intersected Canadian and Spanish datasets, all individuals exist in both datasets and the genotypes are the same&#x2026;.
</p>

<p>
Okay, so let's look at the differences.
</p>
</div>
</div>

<div id="outline-container-orgd81eca3" class="outline-5">
<h5 id="orgd81eca3">Check Differences on Datasets</h5>
<div class="outline-text-5" id="text-orgd81eca3">
<div class="org-src-container">
<pre class="src src-R">names.spanish &lt;- rownames(tab.spanish) # small
names.canada &lt;- rownames(tab.canada)   # large

names.spanish.diff &lt;- names.spanish[!(names.spanish %in% tab.overlap.markers)]
names.canada.diff &lt;- names.canada[!(names.canada %in% tab.overlap.markers)]

length(names.spanish.diff)
length(names.canada.diff)
</pre>
</div>

<pre class="example">
[1] 294
[1] 508
</pre>


<p>
294 new markers in Spanish dataset, and 508 in Canadian dataset.
</p>


<div class="org-src-container">
<pre class="src src-R">paste(sort(names.spanish.diff), collapse=" ")
paste(sort(names.canada.diff), collapse=" ")
#names.canada.diff[names.canada.diff %in% names.spanish.diff]
</pre>
</div>

<pre class="example">
[1] "rs10035105 rs10076408 rs10120169 rs1022249 rs10225000 rs10268365 rs1029905 rs1033651 rs10405913 rs10424263 rs10435440 rs10445105 rs10493155 rs10512073 rs10736027 rs10797122 rs10805304 rs10812206 rs10860692 rs10869200 rs10930124 rs10989329 rs11074843 rs11532602 rs11632698 rs11634071 rs11637194 rs11647013 rs11734226 rs11735207 rs11743216 rs11790808 rs11819487 rs11845926 rs11849247 rs11897697 rs11904750 rs11971667 rs12001157 rs12005018 rs12006781 rs12037123 rs12059286 rs1221986 rs12227359 rs12346965 rs12417751 rs12420493 rs12422743 rs12437252 rs12470133 rs12476047 rs12502690 rs12515368 rs12644278 rs12682602 rs1275642 rs12793010 rs12820069 rs12887411 rs12931636 rs13118998 rs13147122 rs13225805 rs13259555 rs13264696 rs13267264 rs1329005 rs13314478 rs13428862 rs13431489 rs1355196 rs1372756 rs137856 rs1386628 rs1424712 rs1426654 rs1430916 rs1454075 rs1497956 rs1505518 rs1527941 rs1545254 rs1560001 rs1561245 rs1579450 rs1589390 rs160632 rs161330 rs1626593 rs1640007 rs16834698 rs16869058 rs16940213 rs16943302 rs16955641 rs16983070 rs17020449 rs17023989 rs17028962 rs17042329 rs17071817 rs17097599 rs17106727 rs17141671 rs17156078 rs17194591 rs17291521 rs17324762 rs17571029 rs17622920 rs1847458 rs1874848 rs1908970 rs1961712 rs1971518 rs2031077 rs2041876 rs2060241 rs2074685 rs2077305 rs2103186 rs2157739 rs2165183 rs2176804 rs2179932 rs2222723 rs2245007 rs2254835 rs2273440 rs2287807 rs2291977 rs2297604 rs2322847 rs2349057 rs2368540 rs2373901 rs2392243 rs2416012 rs2427285 rs2430408 rs2432055 rs2506814 rs2540834 rs2602647 rs2607272 rs2610166 rs2807873 rs2833135 rs28539549 rs2885857 rs3094315 rs3115876 rs3120834 rs3133916 rs35308549 rs35339599 rs3735453 rs3769439 rs3785138 rs3787062 rs3864814 rs387103 rs3934574 rs3935714 rs4043679 rs4111024 rs4236396 rs424970 rs431873 rs4380043 rs4391434 rs4458410 rs4515498 rs4574760 rs4634387 rs4641198 rs4653109 rs4658538 rs4665344 rs467095 rs468574 rs4694105 rs4698914 rs4711347 rs4768124 rs4768740 rs4786427 rs4822507 rs4918227 rs4954126 rs4980182 rs4986174 rs4987774 rs5028811 rs521896 rs561608 rs568291 rs5907429 rs5907446 rs5923089 rs5926166 rs5955721 rs5969198 rs5974208 rs5977376 rs5981162 rs5985414 rs6061052 rs6138938 rs613906 rs6438013 rs6563855 rs6584061 rs6590725 rs6606874 rs6629448 rs6641825 rs6731269 rs6747946 rs6750986 rs6767104 rs6772001 rs678483 rs6789667 rs6823473 rs6859120 rs6892802 rs6961503 rs6970785 rs698252 rs6997885 rs7003908 rs7023913 rs7034006 rs7046442 rs7051301 rs7065033 rs7103131 rs7118144 rs7140271 rs7142055 rs7145672 rs7155335 rs7171366 rs7175782 rs7205016 rs7210702 rs7256412 rs7294593 rs7299473 rs733327 rs7347681 rs7388704 rs739666 rs7420125 rs7448571 rs7539694 rs7558478 rs7598670 rs7623157 rs7634647 rs7635505 rs7652953 rs7709951 rs7830593 rs7830759 rs7852245 rs790446 rs7973073 rs7993403 rs7999250 rs8018580 rs8027309 rs8036260 rs8064924 rs8096605 rs828869 rs852523 rs914926 rs9294160 rs9300218 rs9305946 rs931885 rs9327877 rs946252 rs9513367 rs961324 rs9632500 rs9825114 rs9848965 rs9856624 rs988675 rs9952775"
[1] "rs10002767 rs10067377 rs10069971 rs10081602 rs10092295 rs1011631 rs1012049 rs10134488 rs10260614 rs1026952 rs1028157 rs1028717 rs10417587 rs10418716 rs10455256 rs10459096 rs10463071 rs10471186 rs10485186 rs10498261 rs10505358 rs10509470 rs10510640 rs10735900 rs10743138 rs10745970 rs10747935 rs10751198 rs10773019 rs10773298 rs10783780 rs10827747 rs10837001 rs10871565 rs10876808 rs10880668 rs10889756 rs10919147 rs10923243 rs10934483 rs10954947 rs10955576 rs10955842 rs11019002 rs11036136 rs11036671 rs11039339 rs11066173 rs11103951 rs11111055 rs11127817 rs1115355 rs11183575 rs11183847 rs11207307 rs11208476 rs11208514 rs11209143 rs11578572 rs11579421 rs11586489 rs11611788 rs11617701 rs11639964 rs11642528 rs11647019 rs11649996 rs11666341 rs11668071 rs11693836 rs11714019 rs11717337 rs11735374 rs11736418 rs1176363 rs11769073 rs11774868 rs11805987 rs11812710 rs11826637 rs11847580 rs11868175 rs11893974 rs11929794 rs11949431 rs12035884 rs12070042 rs12074902 rs12082064 rs12121955 rs1218095 rs12307445 rs12409953 rs12420889 rs12444207 rs12448148 rs12472264 rs12478512 rs12501237 rs12513059 rs12563198 rs12569902 rs12577341 rs12594534 rs12597499 rs12605781 rs12621811 rs12630815 rs12636704 rs12641788 rs12667006 rs12682277 rs12800562 rs12899461 rs12950420 rs12960119 rs13014473 rs13112145 rs13112623 rs13123545 rs13169879 rs13171172 rs13181306 rs1318296 rs13216122 rs13252528 rs13325291 rs13379776 rs13408531 rs1341680 rs1371544 rs1380108 rs1388452 rs1389800 rs1395891 rs1432327 rs1434545 rs1439535 rs1470465 rs1479397 rs1493088 rs150294 rs1505219 rs1509083 rs1509537 rs1522132 rs1564241 rs1566557 rs159228 rs1628854 rs1634479 rs1674729 rs16822696 rs16838078 rs16838677 rs16839483 rs16845000 rs16885247 rs16892685 rs16892729 rs16902328 rs16907106 rs16914850 rs16918895 rs1693663 rs16950116 rs16963394 rs16964618 rs16970687 rs16994051 rs16995641 rs17009882 rs17018414 rs17021145 rs17021825 rs17025482 rs17027938 rs17030742 rs17042107 rs17047489 rs17059403 rs17078877 rs17091704 rs17099872 rs17109726 rs17113072 rs17135626 rs17157802 rs17169630 rs17184090 rs17213264 rs17238052 rs1730633 rs1734907 rs17365336 rs1736867 rs17392154 rs17393434 rs17424278 rs17619600 rs17631231 rs17664384 rs17677886 rs17678153 rs17701996 rs17716105 rs17779253 rs17837692 rs1791909 rs1792525 rs1796937 rs1798911 rs1804025 rs1823762 rs1835655 rs1847022 rs185123 rs1874565 rs1890547 rs1922551 rs195077 rs1960715 rs1997909 rs2041644 rs2061873 rs2113316 rs2131887 rs2164161 rs2174391 rs2213842 rs2242496 rs2252814 rs2276684 rs2284759 rs2287929 rs2298261 rs229835 rs2300179 rs2302332 rs2304136 rs232253 rs2354863 rs2356746 rs2369089 rs238495 rs2395983 rs2399009 rs2400194 rs2415755 rs242724 rs2437802 rs2448191 rs246690 rs2489715 rs249660 rs2515062 rs2570095 rs2575632 rs2591933 rs2596914 rs2618063 rs2627813 rs263734 rs2706464 rs2727165 rs274559 rs277061 rs2786229 rs2809935 rs2816632 rs282258 rs2831208 rs28579689 rs2867048 rs2892383 rs2896850 rs2898407 rs3016176 rs3016752 rs3094395 rs3184504 rs3213928 rs340157 rs34121035 rs34457142 rs344931 rs34585198 rs354518 rs35594730 rs35612996 rs359980 rs3767026 rs3792074 rs3794392 rs3798939 rs3799458 rs3805463 rs3806218 rs3807147 rs3811417 rs3905886 rs3922732 rs3936219 rs4030594 rs4072680 rs4077312 rs4083173 rs4129945 rs4131991 rs4256444 rs4256466 rs4269090 rs429102 rs4317218 rs4332109 rs4405980 rs4414954 rs4419750 rs4422405 rs4466024 rs4470566 rs4479556 rs4523152 rs4529911 rs4603754 rs4618543 rs4638625 rs4642852 rs4647731 rs4648793 rs4655383 rs4656588 rs4675174 rs4678030 rs4678192 rs4688813 rs4699665 rs4699891 rs4735337 rs4740125 rs4756580 rs4760810 rs4780334 rs4792886 rs4834711 rs4860078 rs4862073 rs4862528 rs4865187 rs4892127 rs4932304 rs4946788 rs4951329 rs4962257 rs4965799 rs4974961 rs4975154 rs4980833 rs499974 rs514438 rs530590 rs532731 rs536116 rs548598 rs559665 rs571898 rs5945193 rs5973884 rs604045 rs6424572 rs6446166 rs6449873 rs6485440 rs650440 rs651159 rs6511828 rs6554743 rs6571305 rs6660036 rs6661853 rs6677107 rs6680773 rs6694935 rs6695540 rs6695853 rs670821 rs6738488 rs6739779 rs6750206 rs6765009 rs6788853 rs6793416 rs6824666 rs6846198 rs6860871 rs687578 rs6908310 rs6910046 rs6982764 rs6987055 rs6989728 rs7003452 rs7009774 rs7010796 rs7054689 rs7063059 rs7102109 rs7109235 rs7113382 rs7113554 rs711540 rs7132012 rs7133142 rs7197245 rs7212298 rs722024 rs7226224 rs7254953 rs7300655 rs7312593 rs7315397 rs7320806 rs739742 rs7440269 rs744908 rs7471812 rs747451 rs749981 rs7517754 rs7522356 rs7523055 rs7524430 rs7529073 rs753891 rs7540474 rs7543834 rs7560409 rs7579936 rs7621543 rs7649308 rs7651707 rs7686452 rs7694663 rs7696759 rs7717089 rs7729195 rs7734004 rs7735633 rs7736417 rs7746031 rs7764524 rs777016 rs7771567 rs777827 rs779562 rs7820168 rs7862217 rs7882367 rs7909723 rs7934904 rs7936750 rs7952758 rs7953290 rs7964120 rs7980012 rs7984685 rs8027320 rs803223 rs8035089 rs8035342 rs8057892 rs8079695 rs815802 rs816353 rs823036 rs838425 rs850517 rs867316 rs869026 rs920980 rs9303255 rs9305018 rs9319336 rs9327706 rs934397 rs9354993 rs936525 rs9375604 rs9384847 rs943551 rs9459893 rs9494412 rs9529418 rs9579762 rs9637625 rs966867 rs968845 rs970694 rs9733640 rs9812103 rs9828770 rs9833058 rs9836404 rs9844222 rs9861780 rs989925 rs9941008 rs9999251"
</pre>
</div>
</div>
</div>


<div id="outline-container-org4325a52" class="outline-4">
<h4 id="org4325a52">Summary</h4>
<div class="outline-text-4" id="text-org4325a52">
<p>
The Canadian and Spanish genotypes are 99% the same, and for the overlap that exists between their markers they are completely identical. So&#x2026; why do these two datasets, which describe the same set of individuals, have 300 extra markers in the Spanish and 500 in the Canadian?
</p>

<p>
I spoke with Mallory <span class="timestamp-wrapper"><span class="timestamp">&lt;2020-06-16 Tue&gt;</span></span>, and she said that the overlap was indeed strange but that's how the files were given to her. I very well may have been the last person to touch this project, so it could have been something I may have done previously, a previous merging of these datasets&#x2026;
</p>

<p>
On the other hand, it could be that these families were genotyped together <span class="underline">twice</span>, in which case the fact that the genotypes for the overlapping markers have perfect matches, this adds a large amount of credibility to these genotypes (although the NC calls being consistent would be strange, unless the DNA in those regions were genuinely hard to genotype).
</p>
</div>
</div>
</div>


<div id="outline-container-orgf07819c" class="outline-3">
<h3 id="orgf07819c">Merging the genotypes file</h3>
<div class="outline-text-3" id="text-orgf07819c">
<div class="org-src-container">
<pre class="src src-R"># we've loaded the Spanish and Canadian genotypes already
tab.british &lt;- tableau('~/work/linkage/raw_copy/British/genotypes', header=T)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-R">markers.british &lt;- rownames(tab.british)
markers.spanish &lt;- rownames(tab.spanish)
markers.canadian &lt;- rownames(tab.canada)
length(markers.british)
length(markers.spanish)
length(markers.canadian)
</pre>
</div>

<pre class="example">
[1] 712726
[1] 298006
[1] 298220
</pre>


<p>
The british have the most markers, followed by canadian, and then spanish. So that will be the (reverse) order used to subselect one from the other.
</p>

<div class="org-src-container">
<pre class="src src-R">
intersect.do &lt;- function(big,med,sml) {
   medNbig &lt;- med[med %in% big]
   smlNmed &lt;- sml[sml %in% med]
   bigNmedNsml &lt;- smlNmed[smlNmed %in% medNbig]
   return(sort(bigNmedNsml))
}

# intersect in different ways, should be the same, but good to check
inters = c()
inters[[1]] &lt;- intersect.do(markers.british, markers.canadian, markers.spanish)
inters[[2]] &lt;- intersect.do(markers.british, markers.spanish, markers.canadian)
inters[[3]] &lt;- intersect.do(markers.canadian, markers.british, markers.spanish)
inters[[4]] &lt;- intersect.do(markers.canadian, markers.spanish, markers.british)
inters[[5]] &lt;- intersect.do(markers.spanish, markers.british, markers.canadian)
inters[[6]] &lt;- intersect.do(markers.spanish, markers.canadian, markers.british)

# All the same length?
sapply(inters, length)

# All the same markers?
all(inters[[1]] == inters[[2]])
all(inters[[3]] == inters[[4]])
all(inters[[5]] == inters[[6]])
all(inters[[1]] == inters[[4]])
all(inters[[1]] == inters[[6]])

</pre>
</div>

<pre class="example">
[1] 214563 214563 214563 214563 214563 214563
[1] TRUE
[1] TRUE
[1] TRUE
[1] TRUE
[1] TRUE
</pre>


<p>
Yep, all the same (when sorted). We'll pick one and use that on all three datasets and then merge them.
</p>

<div class="org-src-container">
<pre class="src src-R">common &lt;- inters[[1]]
## Filter rows
mat.canada &lt;- tab.canada[common,]
mat.british &lt;- tab.british[common,]
mat.spanish &lt;- tab.spanish[common,]
## Merge
mat.merged &lt;- data.frame(mat.canada, mat.british, mat.spanish, check.names=T, check.rows=T)
dim(mat.merged)
sort(colnames(mat.merged))
</pre>
</div>

<pre class="example">
[1] 214563    129
  [1] "X2001"   "X2001.1" "X2002"   "X2002.1" "X2003"   "X2003.1" "X2004"
  [8] "X2004.1" "X2005"   "X2005.1" "X2006"   "X2006.1" "X2007"   "X2007.1"
 [15] "X2008"   "X2008.1" "X2009"   "X2009.1" "X2010"   "X2010.1" "X2011"
 [22] "X2011.1" "X2012"   "X2012.1" "X2013"   "X2013.1" "X2014"   "X2014.1"
 [29] "X2015"   "X2015.1" "X2016"   "X2016.1" "X2017"   "X2017.1" "X2018"
 [36] "X2018.1" "X2019"   "X2019.1" "X2020"   "X2020.1" "X2021"   "X2021.1"
 [43] "X2022"   "X2022.1" "X2023"   "X2023.1" "X2024"   "X2024.1" "X2025"
 [50] "X2025.1" "X2026"   "X2026.1" "X2027"   "X2027.1" "X2028"   "X2028.1"
 [57] "X2029"   "X2029.1" "X2030"   "X2030.1" "X2031"   "X2031.1" "X2032"
 [64] "X2032.1" "X2033"   "X2033.1" "X2034"   "X2034.1" "X2035"   "X2035.1"
 [71] "X2036"   "X2036.1" "X2037"   "X2037.1" "X2038"   "X2038.1" "X2039"
 [78] "X2039.1" "X2040"   "X2040.1" "X2041"   "X2041.1" "X2042"   "X2042.1"
 [85] "X2043"   "X2043.1" "X2044"   "X2044.1" "X2045"   "X2045.1" "X2046"
 [92] "X2046.1" "X2047"   "X2047.1" "X2048"   "X2048.1" "X2049"   "X2049.1"
 [99] "X2050"   "X2050.1" "X2051"   "X2051.1" "X2052"   "X2052.1" "X2053"
[106] "X2053.1" "X2054"   "X2054.1" "X2055"   "X2055.1" "X2056"   "X2056.1"
[113] "X2057"   "X2057.1" "X2058"   "X2058.1" "X2059"   "X2059.1" "X2060"
[120] "X2060.1" "X21"     "X22"     "X32"     "X35"     "X44"     "X57"
[127] "X61"     "X79"     "X97"
</pre>

<p>
So we have 129 genotypes, of which some are duplicates (from the Canadian and Spanish) genotypes file. We should check that the ".1" name have identical genotypes and then remove them. (Yes we already know they're identical from before, but better safer than sorry).
</p>

<div class="org-src-container">
<pre class="src src-R">names.merged &lt;- colnames(mat.merged)
names.dupes.bool &lt;- sapply(names.merged, function(x){endsWith(x,".1")})
names.dupes &lt;- names.merged[names.dupes.bool]

sapply(names.dupes, function(dupers){
    namers &lt;- strsplit(dupers, split="\\.1")[[1]]
    ##
    vec.dupes &lt;- mat.merged[,dupers]
    vec.names &lt;- mat.merged[,namers]
    ##
    return(all(vec.dupes == vec.names))
})
</pre>
</div>

<pre class="example">
X2001.1 X2002.1 X2003.1 X2004.1 X2005.1 X2006.1 X2007.1 X2008.1 X2009.1 X2010.1
   TRUE    TRUE    TRUE    TRUE    TRUE    TRUE    TRUE    TRUE    TRUE    TRUE
X2011.1 X2012.1 X2013.1 X2014.1 X2015.1 X2016.1 X2017.1 X2018.1 X2019.1 X2020.1
   TRUE    TRUE    TRUE    TRUE    TRUE    TRUE    TRUE    TRUE    TRUE    TRUE
X2021.1 X2022.1 X2023.1 X2024.1 X2025.1 X2026.1 X2027.1 X2028.1 X2029.1 X2030.1
   TRUE    TRUE    TRUE    TRUE    TRUE    TRUE    TRUE    TRUE    TRUE    TRUE
X2031.1 X2032.1 X2033.1 X2034.1 X2035.1 X2036.1 X2037.1 X2038.1 X2039.1 X2040.1
   TRUE    TRUE    TRUE    TRUE    TRUE    TRUE    TRUE    TRUE    TRUE    TRUE
X2041.1 X2042.1 X2043.1 X2044.1 X2045.1 X2046.1 X2047.1 X2048.1 X2049.1 X2050.1
   TRUE    TRUE    TRUE    TRUE    TRUE    TRUE    TRUE    TRUE    TRUE    TRUE
X2051.1 X2052.1 X2053.1 X2054.1 X2055.1 X2056.1 X2057.1 X2058.1 X2059.1 X2060.1
   TRUE    TRUE    TRUE    TRUE    TRUE    TRUE    TRUE    TRUE    TRUE    TRUE
</pre>


<p>
Yep, identical genotypes for all duplicate individuals &#x2013; let's remove them.
</p>

<div class="org-src-container">
<pre class="src src-R">mat.merged.nodupes &lt;- mat.merged[,!names.dupes.bool]
dim(mat.merged.nodupes)
colnames(mat.merged.nodupes)
</pre>
</div>

<pre class="example">
[1] 214563     69
 [1] "X2001" "X2002" "X2003" "X2004" "X2005" "X2006" "X2007" "X2008" "X2009"
[10] "X2010" "X2011" "X2012" "X2013" "X2014" "X2015" "X2016" "X2017" "X2018"
[19] "X2019" "X2020" "X2021" "X2022" "X2023" "X2024" "X2025" "X2026" "X2027"
[28] "X2028" "X2029" "X2030" "X2031" "X2032" "X2033" "X2034" "X2035" "X2036"
[37] "X2037" "X2038" "X2039" "X2040" "X2041" "X2042" "X2043" "X2044" "X2045"
[46] "X2046" "X2047" "X2048" "X2049" "X2050" "X2051" "X2052" "X2053" "X2054"
[55] "X2055" "X2056" "X2057" "X2058" "X2059" "X2060" "X21"   "X22"   "X44"
[64] "X32"   "X61"   "X79"   "X57"   "X35"   "X97"
</pre>


<p>
Okay, we have a fully merged matrix. Let's write it out
</p>

<div class="org-src-container">
<pre class="src src-bash">mkdir -p ~/work/linkage/preprocessed
</pre>
</div>

<div class="org-src-container">
<pre class="src src-R"># Write genotypes
write.table(mat.merged.nodupes, file="~/work/linkage/preprocessed/genotypes",
            quote=F, sep="\t", col.names = NA)
</pre>
</div>
</div>
</div>

<div id="outline-container-orgab0352e" class="outline-3">
<h3 id="orgab0352e">MAF</h3>
<div class="outline-text-3" id="text-orgab0352e">
<p>
The minor allele frequency file should also be written from the set of markers we have. We will assume all markers have a MAF of 0.5
</p>

<div class="org-src-container">
<pre class="src src-R">cnames &lt;- rownames(mat.merged.nodupes)
maf &lt;- data.frame(Name=cnames, Freq=rep(0.5,length(cnames)))
write.table(maf, file="~/work/linkage/preprocessed/maf.txt", quote=F, sep="\t", row.names=F)
</pre>
</div>
</div>
</div>


<div id="outline-container-org00dc1be" class="outline-3">
<h3 id="org00dc1be">Pedigree</h3>
<div class="outline-text-3" id="text-org00dc1be">
<p>
I will rely on the pedfiles given to me, since I have no way of verifying the pedigrees myself. The family names will be prefixed with '118' and suffixed with '1' '2' or '3' depending for Canadian, Spanish, and British.
</p>
</div>


<div id="outline-container-orgb5c16f9" class="outline-4">
<h4 id="orgb5c16f9">Canadian</h4>
<div class="outline-text-4" id="text-orgb5c16f9">
<div class="org-src-container">
<pre class="src src-text">1183	76211	0	0	1	1
1183	2037	0	0	2	1
1183	2033	76211	2037	1	1
1183	76222	0	0	2	1
1183	2036	2033	76222	1	1
1183	2035	2033	76222	1	1
1183	2034	76211	2037	1	2
1183	2032	76211	2037	2	1
1183	76213	0	0	1	1
1183	2026	76213	2032	1	1
1183	2030	76211	2037	2	1
1183	76215	0	0	1	1
1183	2028	76215	2030	2	1
1183	2027	76215	2030	1	1
1183	2029	0	0	1	1
1183	2031	76211	2037	2	1
1183	2024	2029	2031	2	1
1183	2025	2029	2031	1	2
</pre>
</div>
</div>
</div>


<div id="outline-container-org0ca6daa" class="outline-4">
<h4 id="org0ca6daa">Spanish</h4>
<div class="outline-text-4" id="text-org0ca6daa">
<div class="org-src-container">
<pre class="src src-text">1182	76111	0	0	1	1
1182	76112	0	0	2	1
1182	76121	0	0	1	1
1182	2021	76111	76112	2	1
1182	2022	76111	76112	1	2
1182	2020	76121	2021	1	2
1182	76123	0	0	1	1
1182	2023	76123	2021	1	2
</pre>
</div>
</div>
</div>


<div id="outline-container-org0509370" class="outline-4">
<h4 id="org0509370">British</h4>
<div class="outline-text-4" id="text-org0509370">
<div class="org-src-container">
<pre class="src src-text">1181	7623	0	0	1	1
1181	7624	0	0	2	1
1181	32	7623	7624	2	1
1181	22	7623	7624	2	1
1181	20	0	0	1	1
1181	44	0	0	1	1
1181	79	20	32	1	2
1181	61	20	32	1	2
1181	35	44	22	2	1
1181	57	0	0	1	1
1181	97	57	35	1	2
</pre>
</div>
</div>
</div>


<div id="outline-container-orgd3c252f" class="outline-4">
<h4 id="orgd3c252f">Consistency check</h4>
<div class="outline-text-4" id="text-orgd3c252f">
<p>
Let's export the three tables into the same file and see if there any repeat individuals, and that the parents match. Lisp is good for this.
</p>

<div class="org-src-container">
<pre class="src src-elisp" id="orgab12ca3">(let ((mapped-file nil))
  (with-current-buffer "pedfile.pro"
    (goto-char (point-min))
    ;; Parse file
    (while (not (eobp))
      (let* ((lvals (--map (string-to-number it)
                           (split-string
                            (buffer-substring-no-properties
                             (point)
                             (progn (forward-line 1) (point)))
                            "[	 ]" nil "[ \n]")))
             (entry (list (cadr lvals) ;; id -- alist
                          :family (car lvals)
                          :father (nth 2 lvals) :mother (nth 3 lvals)
                          :gender (cond ((eq (nth 4 lvals) 0) 'unknown)
                                        ((eq (nth 4 lvals) 1) 'male)
                                        ((eq (nth 4 lvals) 2) 'female)
                                        (t (user-error "Gender error")))
                          :affect (cond ((eq (nth 5 lvals) 0) 'unknown)
                                        ((eq (nth 5 lvals) 1) 'yes)
                                        ((eq (nth 5 lvals) 2) 'no)
                                        (t (user-error "affected error"))))))
        (push entry mapped-file))))
  ;; check duplicate ids
  (let* ((ids (mapcar 'identity mapped-file))
         (lenids (length ids))
         (uniqids (-uniq ids))
         (lenuniq (length uniqids)))
    (unless (eq lenids lenuniq)
      (user-error "Id's in pedfile are not unique: %s"
                  (-difference ids uniqids))))
  ;; Check gender and parentage
  (cl-labels ((checkparent (idp relation)
                           (let* ((id-data (alist-get idp mapped-file))
                                  (gender (plist-get id-data :gender)))
                             (if (eq 0 idp)
                                 (format "no %s as expected." relation)
                               (unless id-data
                                 (user-error "%id: %d (%s) does not exist "
                                             id idp relation))
                               (cond ((and (eq relation 'mother)
                                           (not (eq gender 'female)))
                                      (user-error "%d: %d (%s) is not female, but %s"
                                                  id idp relation gender))
                                     ((and (eq relation 'father)
                                           (not (eq gender 'male)))
                                      (user-error "%d: %d (%s) is not male, but %s"
                                                  id idp relation gender))
                                     (t (format "%d (%s,%s) clear"
                                                idp relation gender)))))))
    ;; recursion would be expensive, simple loop would suffice
    (let ((res nil))
      (dolist (entry mapped-file (message (mapconcat 'identity res "\n")))
        (let ((id (car entry))
               (mother (plist-get (cdr entry) :mother))
               (father (plist-get (cdr entry) :father)))
          (push (format "%d\t%s\t%s" id
                        (checkparent mother 'mother)
                        (checkparent father 'father))
                res))))))
</pre>
</div>

<pre class="example">
76211	no mother as expected.	no father as expected.
2037	no mother as expected.	no father as expected.
2033	2037 (mother,female) clear	76211 (father,male) clear
76222	no mother as expected.	no father as expected.
2036	76222 (mother,female) clear	2033 (father,male) clear
2035	76222 (mother,female) clear	2033 (father,male) clear
2034	2037 (mother,female) clear	76211 (father,male) clear
2032	2037 (mother,female) clear	76211 (father,male) clear
76213	no mother as expected.	no father as expected.
2026	2032 (mother,female) clear	76213 (father,male) clear
2030	2037 (mother,female) clear	76211 (father,male) clear
76215	no mother as expected.	no father as expected.
2028	2030 (mother,female) clear	76215 (father,male) clear
2027	2030 (mother,female) clear	76215 (father,male) clear
2029	no mother as expected.	no father as expected.
2031	2037 (mother,female) clear	76211 (father,male) clear
2024	2031 (mother,female) clear	2029 (father,male) clear
2025	2031 (mother,female) clear	2029 (father,male) clear
76111	no mother as expected.	no father as expected.
76112	no mother as expected.	no father as expected.
76121	no mother as expected.	no father as expected.
2021	76112 (mother,female) clear	76111 (father,male) clear
2022	76112 (mother,female) clear	76111 (father,male) clear
2020	2021 (mother,female) clear	76121 (father,male) clear
76123	no mother as expected.	no father as expected.
2023	2021 (mother,female) clear	76123 (father,male) clear
7623	no mother as expected.	no father as expected.
7624	no mother as expected.	no father as expected.
32	7624 (mother,female) clear	7623 (father,male) clear
22	7624 (mother,female) clear	7623 (father,male) clear
20	no mother as expected.	no father as expected.
44	no mother as expected.	no father as expected.
79	32 (mother,female) clear	20 (father,male) clear
61	32 (mother,female) clear	20 (father,male) clear
35	22 (mother,female) clear	44 (father,male) clear
57	no mother as expected.	no father as expected.
97	35 (mother,female) clear	57 (father,male) clear
</pre>


<p>
Okay, pedigree appears to have no duplicates, and all parents appear to exist and have the right genders.
</p>
</div>
</div>
</div>


<div id="outline-container-orgc987f61" class="outline-3">
<h3 id="orgc987f61">Map file</h3>
<div class="outline-text-3" id="text-orgc987f61">
<dl class="org-dl">
<dt>Canada &amp; Spain</dt><dd>Infinium Multi Ethnic Global BeadChip (1779819 markers)</dd>
<dt>England</dt><dd>Omni-X-24 BeadChip (741000 markers)</dd>
</dl>


<p>
Interesting, Canada and Spain actually had the smaller number of markers than the British and yet they came from a larger chip.
</p>

<p>
Anyway, we will need to download the map files for each chip, check the marker overlap and check that marker physical positions make sense. Otherwise we'll need to pick a side.
</p>
</div>

<div id="outline-container-orga632fad" class="outline-4">
<h4 id="orga632fad">Infinium Multi Ethnic Global Beadchip</h4>
<div class="outline-text-4" id="text-orga632fad">
<p>
The <a href="https://www.illumina.com/search.html?q=Infinium%20Multi%20Ethnic%20Global&amp;filter=all&amp;p=1">closest match</a> only offers a PDF for the Beadchip, but no specific map files. I would guess that "Infinium Multi Ethnic Global Beadchip" is part of the "Infinium Multi Ethnic Global" Kit, so that is what <a href="https://support.illumina.com/downloads/infinium-multi-ethnic-global-8-v1-support-files.html">I went with</a>. The file chosen was "Infinium Multi-Ethnic Global-8 v1.0 Physical and Genetic Coordinates" but two builds were offered: hg19 and hg38.
</p>

<p>
The linkage plotting tools only have chromosome map for hg18 and hg19, so I opted to download the hg19 for compatibility.
</p>

<div class="org-src-container">
<pre class="src src-sh">wget https://support.illumina.com/content/dam/illumina-support/documents/downloads/productfiles/multiethnic-global/multi-ethnic-global-8-d1-physical-and-genetic-coordinates.zip -O ~/work/linkage/map/multi-ethnic-global-8-d1-physical-genetic-coordinates.zip
cd ~/work/linkage/map/
unzip multi-ethnic-global-8-d1-physical-genetic-coordinates.zip
ls
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">InfiniumOmniExpress-24v1-3<sub>A1.csv</sub><sub>Physical</sub>-and-Genetic-Coordinates.txt</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">infinium-omniexpress-24-v1-3-a1-physical-genetic-coordinates.zip</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">multi-ethnic-global-8-d1-physical-genetic-coordinates.zip</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Multi-EthnicGlobal<sub>D1.csv</sub><sub>Physical</sub>-and-Genetic-Coordinates.txt</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">ps.png</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>

<p>
A quick peek:
</p>
<div class="org-src-container">
<pre class="src src-sh" id="org580b00e">head -1 $name
cat $name | grep "^rs" | head | cut -f 1-10
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<tbody>
<tr>
<td class="org-left">Name</td>
<td class="org-right">Chr</td>
<td class="org-right">MapInfo</td>
<td class="org-right">deCODE(cM)</td>
</tr>

<tr>
<td class="org-left">rs10000008</td>
<td class="org-right">4</td>
<td class="org-right">172776204</td>
<td class="org-right">166.8903</td>
</tr>

<tr>
<td class="org-left">rs10000011</td>
<td class="org-right">4</td>
<td class="org-right">138223055</td>
<td class="org-right">133.7645</td>
</tr>

<tr>
<td class="org-left">rs10000030</td>
<td class="org-right">4</td>
<td class="org-right">103374154</td>
<td class="org-right">107.4204</td>
</tr>

<tr>
<td class="org-left">rs1000003</td>
<td class="org-right">3</td>
<td class="org-right">98342907</td>
<td class="org-right">111.7517</td>
</tr>

<tr>
<td class="org-left">rs10000056</td>
<td class="org-right">4</td>
<td class="org-right">189321617</td>
<td class="org-right">203.1508</td>
</tr>

<tr>
<td class="org-left">rs1000007</td>
<td class="org-right">2</td>
<td class="org-right">237752054</td>
<td class="org-right">249.0087</td>
</tr>

<tr>
<td class="org-left">rs10000073</td>
<td class="org-right">4</td>
<td class="org-right">43022222</td>
<td class="org-right">63.9959</td>
</tr>

<tr>
<td class="org-left">rs10000092</td>
<td class="org-right">4</td>
<td class="org-right">21895517</td>
<td class="org-right">37.309</td>
</tr>

<tr>
<td class="org-left">rs1000014</td>
<td class="org-right">16</td>
<td class="org-right">24417536</td>
<td class="org-right">47.977</td>
</tr>

<tr>
<td class="org-left">rs1000016</td>
<td class="org-right">2</td>
<td class="org-right">235690982</td>
<td class="org-right">244.3528</td>
</tr>
</tbody>
</table>

<p>
A quick check on UCSC for:
</p>

<ul class="org-ul">
<li>hg38:
<ul class="org-ul">
<li>rs1000016
<ul class="org-ul">
<li>Position: chr2:234782338-234782338 (does not match)</li>
<li><a href="https://genome.ucsc.edu/cgi-bin/hgc?hgsid=847952011_zNJAYkkl1WqOaR7eAd9E6HJWah8q&amp;c=chr2&amp;l=234782237&amp;r=234782438&amp;o=234782337&amp;t=234782338&amp;g=dbSnp153Common&amp;i=rs1000016">Link</a></li>
</ul></li>
<li>rs1000014
<ul class="org-ul">
<li>Position: chr16:24406215-24406215 (does not match)</li>
<li><a href="https://genome.ucsc.edu/cgi-bin/hgc?hgsid=847952011_zNJAYkkl1WqOaR7eAd9E6HJWah8q&amp;c=chr16&amp;l=24406114&amp;r=24406315&amp;o=24406214&amp;t=24406215&amp;g=dbSnp153Common&amp;i=rs1000014">Link</a></li>
</ul></li>
</ul></li>
<li>hg37:
<ul class="org-ul">
<li>rs1000016
<ul class="org-ul">
<li>Position: chr2:235690982-235690982  (matches table)</li>
<li><a href="https://genome.ucsc.edu/cgi-bin/hgc?hgsid=847952011_zNJAYkkl1WqOaR7eAd9E6HJWah8q&amp;c=chr2&amp;l=235690881&amp;r=235691082&amp;o=235690981&amp;t=235690982&amp;g=dbSnp153Common&amp;i=rs1000016">Link</a></li>
</ul></li>
<li>rs1000014
<ul class="org-ul">
<li>Position: chr16:24417536-24417536 (matches table)</li>
<li><a href="https://genome.ucsc.edu/cgi-bin/hgc?hgsid=847952011_zNJAYkkl1WqOaR7eAd9E6HJWah8q&amp;c=chr16&amp;l=24417435&amp;r=24417636&amp;o=24417535&amp;t=24417536&amp;g=dbSnp153Common&amp;i=rs1000014">Link</a></li>
</ul></li>
</ul></li>
</ul>

<p>
So I am reasonably confident this map file is hg19/hg37
</p>
</div>
</div>


<div id="outline-container-org64f4a6a" class="outline-4">
<h4 id="org64f4a6a">Omni-X-24 BeadChip</h4>
<div class="outline-text-4" id="text-org64f4a6a">
<p>
The <a href="https://support.illumina.com/downloads/infinium-omniexpress-24-v1-3-support-files.html">closest match</a> was the OmniExpress-24, and the file chosen was the "Infinium OmniExpress-24 v1.3 Physical and Genetic Coordinates" but no genome was given.
</p>

<div class="org-src-container">
<pre class="src src-sh">wget https://support.illumina.com/content/dam/illumina-support/documents/downloads/productfiles/humanomniexpress-24/v1-3/infinium-omniexpress-24-v1-3-a1-physical-genetic-coordinates.zip -O ~/work/linkage/map/infinium-omniexpress-24-v1-3-a1-physical-genetic-coordinates.zip
cd ~/work/linkage/map/
unzip infinium-omniexpress-24-v1-3-a1-physical-genetic-coordinates.zip
ls
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">InfiniumOmniExpress-24v1-3<sub>A1.csv</sub><sub>Physical</sub>-and-Genetic-Coordinates.txt</td>
<td class="org-left">multi-ethnic-global-8-d1-physical-genetic-coordinates.zip</td>
</tr>

<tr>
<td class="org-left">infinium-omniexpress-24-v1-3-a1-physical-genetic-coordinates.zip</td>
<td class="org-left">Multi-EthnicGlobal<sub>D1.csv</sub><sub>Physical</sub>-and-Genetic-Coordinates.txt</td>
</tr>
</tbody>
</table>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<tbody>
<tr>
<td class="org-left">Name</td>
<td class="org-right">Chr</td>
<td class="org-right">MapInfo</td>
<td class="org-right">deCODE(cM)</td>
</tr>

<tr>
<td class="org-left">rs10000911</td>
<td class="org-right">4</td>
<td class="org-right">144136193</td>
<td class="org-right">140.08</td>
</tr>

<tr>
<td class="org-left">rs10000988</td>
<td class="org-right">4</td>
<td class="org-right">76010255</td>
<td class="org-right">85.247</td>
</tr>

<tr>
<td class="org-left">rs10002181</td>
<td class="org-right">4</td>
<td class="org-right">142250415</td>
<td class="org-right">138.919</td>
</tr>

<tr>
<td class="org-left">rs10003721</td>
<td class="org-right">4</td>
<td class="org-right">74440784</td>
<td class="org-right">83.5039</td>
</tr>

<tr>
<td class="org-left">rs10005140</td>
<td class="org-right">4</td>
<td class="org-right">22365603</td>
<td class="org-right">37.6755</td>
</tr>

<tr>
<td class="org-left">rs10005242</td>
<td class="org-right">4</td>
<td class="org-right">5949558</td>
<td class="org-right">10.9662</td>
</tr>

<tr>
<td class="org-left">rs10010434</td>
<td class="org-right">4</td>
<td class="org-right">2701540</td>
<td class="org-right">3.5678</td>
</tr>

<tr>
<td class="org-left">rs10011256</td>
<td class="org-right">4</td>
<td class="org-right">110792907</td>
<td class="org-right">113.594</td>
</tr>

<tr>
<td class="org-left">rs1001131</td>
<td class="org-right">2</td>
<td class="org-right">115010406</td>
<td class="org-right">126.4217</td>
</tr>

<tr>
<td class="org-left">rs10011926</td>
<td class="org-right">4</td>
<td class="org-right">111026927</td>
<td class="org-right">113.8203</td>
</tr>
</tbody>
</table>

<p>
A quick check on UCSC for:
</p>

<ul class="org-ul">
<li>hg38:
<ul class="org-ul">
<li>rs10002181:
<ul class="org-ul">
<li>Position: chr4:141329261-141329261 (does not match)</li>
<li><a href="https://genome.ucsc.edu/cgi-bin/hgc?hgsid=847952011_zNJAYkkl1WqOaR7eAd9E6HJWah8q&amp;c=chr4&amp;l=141329160&amp;r=141329361&amp;o=141329260&amp;t=141329261&amp;g=dbSnp153Common&amp;i=rs10002181">Link</a></li>
</ul></li>
<li>rs10011926:
<ul class="org-ul">
<li>Position: chr4:110105771-110105771 (does not match)</li>
<li><a href="https://genome.ucsc.edu/cgi-bin/hgc?hgsid=847952011_zNJAYkkl1WqOaR7eAd9E6HJWah8q&amp;c=chr4&amp;l=110105720&amp;r=110105821&amp;o=110105770&amp;t=110105771&amp;g=dbSnp153Common&amp;i=rs10011926">Link</a></li>
</ul></li>
</ul></li>

<li>hg37:
<ul class="org-ul">
<li>rs10002181:
<ul class="org-ul">
<li>Position: chr4:142250415-142250415 (matches table)</li>
<li><a href="https://genome.ucsc.edu/cgi-bin/hgc?hgsid=847952011_zNJAYkkl1WqOaR7eAd9E6HJWah8q&amp;c=chr4&amp;l=142250164&amp;r=142250665&amp;o=142250414&amp;t=142250415&amp;g=dbSnp153Common&amp;i=rs10002181">Link</a></li>
</ul></li>
<li>rs10011926
<ul class="org-ul">
<li>Position: chr4:111026927-111026927 (matches table)</li>
<li><a href="https://genome.ucsc.edu/cgi-bin/hgc?hgsid=847952011_zNJAYkkl1WqOaR7eAd9E6HJWah8q&amp;c=chr4&amp;l=111026876&amp;r=111026977&amp;o=111026926&amp;t=111026927&amp;g=dbSnp153Common&amp;i=rs10011926">Link</a></li>
</ul></li>
</ul></li>
</ul>


<p>
So I am reasonably confident this map file is hg19.
</p>
</div>
</div>

<div id="outline-container-org3ea1354" class="outline-4">
<h4 id="org3ea1354">Combining Maps</h4>
<div class="outline-text-4" id="text-org3ea1354">
<p>
We currently have two hg19 marker maps and we want to merge them on common marker names and positions. R is better suited for this:
</p>

<div class="org-src-container">
<pre class="src src-R">tableau &lt;- function(name, ...) {
  read.table(name, stringsAsFactors=F, row.names=1, ...)
}

map.omnix &lt;- tableau('~/work/linkage/map/InfiniumOmniExpress-24v1-3_A1.csv_Physical-and-Genetic-Coordinates.txt', header=T)
map.global &lt;- tableau('~/work/linkage/map/Multi-EthnicGlobal_D1.csv_Physical-and-Genetic-Coordinates.txt', header=T)
common.markers &lt;- rownames(tableau('~/work/linkage/preprocessed/maf.txt', header=T))

</pre>
</div>

<p>
Peek at each file:
</p>

<div class="org-src-container">
<pre class="src src-R">dim(map.omnix)
dim(map.global)
length(common.markers)
## peek
head(map.omnix)
head(map.global)
head(common.markers)
</pre>
</div>

<pre class="example">
[1] 714238      3
[1] 1748250       3
[1] 214563
           Chr   MapInfo deCODE.cM.
rs10000911   4 144136193   140.0800
rs10000988   4  76010255    85.2470
rs10002181   4 142250415   138.9190
rs10003721   4  74440784    83.5039
rs10005140   4  22365603    37.6755
rs10005242   4   5949558    10.9662
                    Chr   MapInfo deCODE.cM.
10:100012219-GT      10 100012219   118.9888
10:100013340-CT      10 100013340   118.9910
10:100013459-TCTC-T  10 100013459   118.9912
10:100013467-GA      10 100013467   118.9912
10:100015474-GA      10 100015474   118.9951
10:100016685-CT      10 100016685   118.9974
[1] "rs1000002"  "rs1000003"  "rs10000030" "rs10000037" "rs10000041"
[6] "rs1000007"
</pre>

<p>
700k markers in the omnix, and 1.7M markers in the global, with 200k markers from our genotypes.
</p>

<p>
The <code>common.markers</code> were derived from the markers given in the maf.txt file (which was derived from our combined genotypes file). We will now subselect these markers from each map before intersecting.
</p>

<div class="org-src-container">
<pre class="src src-R">map.omnix.sub &lt;- map.omnix[rownames(map.omnix) %in% common.markers,]
map.global.sub &lt;- map.global[rownames(map.global) %in% common.markers,]
dim(map.omnix.sub)
dim(map.global.sub)
</pre>
</div>

<pre class="example">
[1] 211729      3
[1] 117708      3
</pre>


<p>
700k to 200k in the omnix, and 1.7M to 117k in the global. Let's intersect.
</p>
</div>

<div id="outline-container-orgfb0e919" class="outline-5">
<h5 id="orgfb0e919">Intersection</h5>
<div class="outline-text-5" id="text-orgfb0e919">
<p>
First, we subselect the global from the omnix
</p>

<div class="org-src-container">
<pre class="src src-R">map.intersect1 &lt;- map.global.sub[rownames(map.global.sub) %in% rownames(map.omnix.sub),]
dim(map.intersect1)
head(map.intersect1)
</pre>
</div>

<pre class="example">
[1] 116641      3
           Chr   MapInfo deCODE.cM.
rs10000030   4 103374154   107.4204
rs1000003    3  98342907   111.7517
rs1000007    2 237752054   249.0087
rs1000016    2 235690982   244.3528
rs10000180   4  83899764    90.5530
rs10000272   4 189690383   204.0179
</pre>


<p>
and now we subselect the omnix from the global. (The purpose of this is to see if we get the same map, and to see if the physical and cM positions agree across maps for the same markers).
</p>

<div class="org-src-container">
<pre class="src src-R">map.intersect2 &lt;- map.omnix.sub[rownames(map.omnix.sub) %in% rownames(map.global.sub),]
dim(map.intersect2)
head(map.intersect2)
</pre>
</div>

<pre class="example">
[1] 116641      3
           Chr   MapInfo deCODE.cM.
rs1001131    2 115010406   126.4217
rs10068316   5   5938780    15.9405
rs10466408  11  12839527    21.8288
rs10485597  20  20239050    49.4944
rs10488810  11  35213378    51.6996
rs10788162  10 123037309   145.1604
</pre>


<p>
Same number of markers as before, but I guess the order of markers is different. Let's do a quick sort of both
</p>
</div>
</div>

<div id="outline-container-org9fa21bc" class="outline-5">
<h5 id="org9fa21bc">Consistency check (small)</h5>
<div class="outline-text-5" id="text-org9fa21bc">
<div class="org-src-container">
<pre class="src src-R">head(map.intersect1[order(rownames(map.intersect1)),])
head(map.intersect2[order(rownames(map.intersect2)),])
</pre>
</div>

<pre class="example">
           Chr   MapInfo deCODE.cM.
rs1000003    3  98342907   111.7517
rs10000030   4 103374154   107.4204
rs1000007    2 237752054   249.0087
rs1000016    2 235690982   244.3528
rs10000180   4  83899764    90.5530
rs10000272   4 189690383   204.0179
           Chr   MapInfo deCODE.cM.
rs1000003    3  98342907   111.7517
rs10000030   4 103374154   107.4204
rs1000007    2 237752054   249.0087
rs1000016    2 235690982   244.3528
rs10000180   4  83899764    90.5530
rs10000272   4 189690383   204.0179
</pre>

<p>
Sorting by marker name gives the same top 10 markers in each file with identical physical and genetic positions. Let's check all markers.
</p>

<div class="org-src-container">
<pre class="src src-R">all(sort(rownames(map.intersect1)) == sort(rownames(map.intersect2)))
length(rownames(map.intersect1))
</pre>
</div>

<pre class="example">
[1] TRUE
[1] 116641
</pre>



<p>
And now all positions
</p>
</div>
</div>

<div id="outline-container-org37a09dc" class="outline-5">
<h5 id="org37a09dc">Consistency check (all)</h5>
<div class="outline-text-5" id="text-org37a09dc">
<p>
(Note: this was slow, so I wrote a parallel implementation based on <a href="https://stackoverflow.com/questions/31050556/parallel-version-of-sapply">this post</a>, which gave a 3x speedup)
</p>


<div class="org-src-container">
<pre class="src src-R">library(parallel)
## An mc-version of the sapply function.
mcsapply &lt;- function (X, FUN, ..., simplify = TRUE, USE.NAMES = TRUE) {
  FUN &lt;- match.fun(FUN)
  answer &lt;- parallel::mclapply(X = X, FUN = FUN, ...)
  if (USE.NAMES &amp;&amp; is.character(X) &amp;&amp; is.null(names(answer)))
    names(answer) &lt;- X
  if (!isFALSE(simplify) &amp;&amp; length(answer))
    simplify2array(answer, higher = (simplify == "array"))
  else answer
}

</pre>
</div>

<div class="org-src-container">
<pre class="src src-R">comm.markers &lt;- rownames(map.intersect1)  ## common to both datasets
comm.len &lt;- length(comm.markers)
i &lt;- 0

res &lt;- mcsapply(comm.markers, function(marker){
  rowdata.i1 &lt;- map.intersect1[marker,]
  rowdata.i2 &lt;- map.intersect2[marker,]
  i &lt;&lt;- i + 1
  message(marker, " ", floor(100 * i / comm.len), "  \r", appendLF=F)
  flush.console()
  return(all(rowdata.i1 == rowdata.i2))
}, mc.cores=3)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-R">summary(res)
</pre>
</div>

<pre class="example">
   Mode   FALSE    TRUE    NA's
logical       1  116170     470
</pre>


<p>
So it looks like 116170 markers were in complete agreement with one another. 470 were not sure (or could not do the comparison) and 1 was flat out wrong.
</p>

<p>
Let us look at these outliers and see whether the issue was to do with precision (e.g. 15.1416 vs 15.14159) or something more concerning.
</p>
</div>
</div>

<div id="outline-container-org9a30028" class="outline-5">
<h5 id="org9a30028">Examining Outliers</h5>
<div class="outline-text-5" id="text-org9a30028">
</div>
<ul class="org-ul">
<li><a id="org7d6c02f"></a>False Markers<br />
<div class="outline-text-6" id="text-org7d6c02f">
<p>
Let's examine the one False marker
</p>

<div class="org-src-container">
<pre class="src src-R">names(res)[res == FALSE &amp; !(is.na(res))] # need to be explicit
</pre>
</div>

<pre class="example">
rs2247450
</pre>


<p>
and now a peek at this marker in both datasets:
</p>

<div class="org-src-container">
<pre class="src src-R" id="orge9590bd">rbind(c(name, "intersect1", map.intersect1[name,]),
      c(name, "intersect2", map.intersect2[name,]),
      c(name, "omnix", map.omnix[name,]),
      c(name, "global", map.global[name,]))
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<tbody>
<tr>
<td class="org-left">rs2247450</td>
<td class="org-left">intersect1</td>
<td class="org-right">5</td>
<td class="org-right">79381796</td>
<td class="org-right">95.3136</td>
</tr>

<tr>
<td class="org-left">rs2247450</td>
<td class="org-left">intersect2</td>
<td class="org-right">0</td>
<td class="org-right">0</td>
<td class="org-right">NA</td>
</tr>

<tr>
<td class="org-left">rs2247450</td>
<td class="org-left">omnix</td>
<td class="org-right">0</td>
<td class="org-right">0</td>
<td class="org-right">NA</td>
</tr>

<tr>
<td class="org-left">rs2247450</td>
<td class="org-left">global</td>
<td class="org-right">5</td>
<td class="org-right">79381796</td>
<td class="org-right">95.3136</td>
</tr>
</tbody>
</table>

<p>
It looks like this marker does not appear to be defined in the omnix dataset. We will drop it
</p>
</div>
</li>

<li><a id="org4c29242"></a>NA Markers<br />
<div class="outline-text-6" id="text-org4c29242">
<p>
Let's look at 10 of the 470 undefined markers
</p>

<div class="org-src-container">
<pre class="src src-R">na.markers &lt;- names(res)[is.na(res)]
head(na.markers)
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">rs10436791</td>
</tr>

<tr>
<td class="org-left">rs10436793</td>
</tr>

<tr>
<td class="org-left">rs10465457</td>
</tr>

<tr>
<td class="org-left">rs10465458</td>
</tr>

<tr>
<td class="org-left">rs10465469</td>
</tr>

<tr>
<td class="org-left">rs1050190</td>
</tr>
</tbody>
</table>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">rs10436791</td>
<td class="org-left">intersect1</td>
<td class="org-left">Y</td>
<td class="org-right">14518606</td>
<td class="org-left">NA</td>
</tr>

<tr>
<td class="org-left">rs10436791</td>
<td class="org-left">intersect2</td>
<td class="org-left">Y</td>
<td class="org-right">14518606</td>
<td class="org-left">NA</td>
</tr>

<tr>
<td class="org-left">rs10436791</td>
<td class="org-left">omnix</td>
<td class="org-left">Y</td>
<td class="org-right">14518606</td>
<td class="org-left">NA</td>
</tr>

<tr>
<td class="org-left">rs10436791</td>
<td class="org-left">global</td>
<td class="org-left">Y</td>
<td class="org-right">14518606</td>
<td class="org-left">NA</td>
</tr>
</tbody>
</table>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">rs1050190</td>
<td class="org-left">intersect1</td>
<td class="org-right">0</td>
<td class="org-right">0</td>
<td class="org-left">NA</td>
</tr>

<tr>
<td class="org-left">rs1050190</td>
<td class="org-left">intersect2</td>
<td class="org-right">0</td>
<td class="org-right">0</td>
<td class="org-left">NA</td>
</tr>

<tr>
<td class="org-left">rs1050190</td>
<td class="org-left">omnix</td>
<td class="org-right">0</td>
<td class="org-right">0</td>
<td class="org-left">NA</td>
</tr>

<tr>
<td class="org-left">rs1050190</td>
<td class="org-left">global</td>
<td class="org-right">0</td>
<td class="org-right">0</td>
<td class="org-left">NA</td>
</tr>
</tbody>
</table>

<p>
Just from comparing the top and bottom marker in that list of 10 we can see that the cM information is NA.
</p>

<p>
This makes sense because for the top marker it is on the Y chromosome for which there is 0 recombination probability (or at least a not yet well-understood probability of a recombination event).
</p>

<p>
For the bottom marker, these have a chromosome of 0&#x2026;, which I have no idea what that means, but that is also how they are written in the original map files.
</p>
</div>
</li>

<li><a id="orge118cb4"></a>Summarize Outliers by Chromosome<br />
<div class="outline-text-6" id="text-orge118cb4">
<p>
Let's summarize the chromosomes of these outliers and see if they are on weird chromosomes. If they are then we can just drop them.
</p>

<div class="org-src-container">
<pre class="src src-R">markers.outliers &lt;- names(res)[is.na(res) | res==FALSE]
source.outliers &lt;- rbind(map.global[markers.outliers,],
                         map.omnix[markers.outliers,])
head(source.outliers)
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">5</td>
<td class="org-right">79381796</td>
<td class="org-left">95.3136</td>
</tr>

<tr>
<td class="org-left">Y</td>
<td class="org-right">14518606</td>
<td class="org-left">nil</td>
</tr>

<tr>
<td class="org-left">Y</td>
<td class="org-right">14266799</td>
<td class="org-left">nil</td>
</tr>

<tr>
<td class="org-left">Y</td>
<td class="org-right">17913958</td>
<td class="org-left">nil</td>
</tr>

<tr>
<td class="org-left">Y</td>
<td class="org-right">19306942</td>
<td class="org-left">nil</td>
</tr>

<tr>
<td class="org-left">Y</td>
<td class="org-right">7796708</td>
<td class="org-left">nil</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-R">source.chroms &lt;- source.outliers$Chr
table(source.chroms)
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<tbody>
<tr>
<td class="org-right">0</td>
<td class="org-right">15</td>
</tr>

<tr>
<td class="org-right">5</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-right">XY</td>
<td class="org-right">12</td>
</tr>

<tr>
<td class="org-right">Y</td>
<td class="org-right">914</td>
</tr>
</tbody>
</table>

<p>
Most of these undefined markers are on the Y, a few on the '0', a few on the XY overlap, and 1 marker on chr5 (as explored previously).
</p>

<p>
Not very useful markers, I will drop these from the map.
</p>
</div>
</li>

<li><a id="orgfef5319"></a>Removing outliers<br />
<div class="outline-text-6" id="text-orgfef5319">
<div class="org-src-container">
<pre class="src src-R">map.nooutliers &lt;- map.intersect1[!(rownames(map.intersect1) %in% markers.outliers),]
dim(map.nooutliers)
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />
</colgroup>
<tbody>
<tr>
<td class="org-right">116170</td>
</tr>

<tr>
<td class="org-right">3</td>
</tr>
</tbody>
</table>

<p>
and a quick check for NA values:
</p>

<div class="org-src-container">
<pre class="src src-R">table(is.na(map.nooutliers))
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<tbody>
<tr>
<td class="org-left">FALSE</td>
<td class="org-right">348510</td>
</tr>
</tbody>
</table>


<p>
Good, this is a clean table.
</p>
</div>
</li>
</ul>
</div>

<div id="outline-container-org295dce1" class="outline-5">
<h5 id="org295dce1">Sort the map</h5>
<div class="outline-text-5" id="text-org295dce1">
<p>
Order the map by chromosome and then physical position
</p>

<div class="org-src-container">
<pre class="src src-R">## List of chromosomes
sort(unique(map.nooutliers$Chr))
</pre>
</div>

<pre class="example">
 [1] "1"  "10" "11" "12" "13" "14" "15" "16" "17" "18" "19" "2"  "20" "21" "22"
[16] "3"  "4"  "5"  "6"  "7"  "8"  "9"  "X"
</pre>


<p>
Sorting numeric first, then alphanumeric is something I don't wish to implement. I will just manually specify chromosomes to speed up processing.
</p>

<div class="org-src-container">
<pre class="src src-R">tab.only.numeric &lt;- map.nooutliers[map.nooutliers$Chr != "X",]
tab.only.X &lt;- map.nooutliers[map.nooutliers$Chr == "X",]
## sort the X by physpos only
tab.only.X.sorted &lt;- tab.only.X[order(tab.only.X$MapInfo),]

## Convert the chrom to numeric
tab.only.numeric$Chr &lt;- as.integer(tab.only.numeric$Chr)
tab.only.numeric.sorted &lt;- tab.only.numeric[order(tab.only.numeric$Chr,
                                                  tab.only.numeric$MapInfo),]
## sort the numeric by chrom then physpos
tab.only.numeric.sorted &lt;- tab.only.numeric[order(tab.only.numeric$Chr,
                                                  tab.only.numeric$MapInfo),]

## bind the tables together
ordered.map &lt;- rbind(tab.only.numeric.sorted, tab.only.X.sorted)

head(ordered.map, 3)
tail(ordered.map, 3)

unique(ordered.map$Chr)
</pre>
</div>

<pre class="example">
          Chr MapInfo deCODE.cM.
rs4475691   1  846808          0
rs9777703   1  928836          0
rs3128117   1  944564          0
           Chr   MapInfo deCODE.cM.
rs11156600   X 154440161   189.3531
rs547447     X 154479421   189.4259
rs12557310   X 154735698   189.9009
 [1] "1"  "2"  "3"  "4"  "5"  "6"  "7"  "8"  "9"  "10" "11" "12" "13" "14" "15"
[16] "16" "17" "18" "19" "20" "21" "22" "X"
</pre>

<p>
and now we format the output
</p>
</div>
</div>

<div id="outline-container-org5fd0626" class="outline-5">
<h5 id="org5fd0626">Write the output</h5>
<div class="outline-text-5" id="text-org5fd0626">
<p>
We need to convert this now into the usual weird linkage map format: chromosome, marker, cM, physical, marker, "x" (who invented this format?)
</p>

<div class="org-src-container">
<pre class="src src-conf">01      rs28625089      0.83019 830190  rs28625089      x
</pre>
</div>


<p>
Quick print out
</p>

<div class="org-src-container">
<pre class="src src-R">cat(sprintf("%s\t%s\t%.6f\t%d\t%s\tx", "Chr", "Name", 0, 0, "Name"),
    file="~/work/linkage/map/map.all.txt", append=F, fill=T)
res &lt;- lapply(1:nrow(ordered.map), function(index){
  row &lt;- ordered.map[index,]
  marker &lt;- rownames(row)
  chrom &lt;- row$Chr
  chromD &lt;- as.integer(row$Chr)
  phys &lt;- row$MapInfo
  centim &lt;- row$deCODE.cM.

  if (is.na(chromD)){  ## is not 1-22
    fstring &lt;- "%s\t%s\t%.6f\t%d\t%s\tx"
  } else {
    fstring &lt;- "%02d\t%s\t%.6f\t%d\t%s\tx"
    chrom &lt;- chromD
  }

  cat(sprintf(fstring, chrom, marker, centim, phys, marker),
      file="~/work/linkage/map/map.all.txt",
      append = T, fill = T)
  return(0)
})
print("done.")  ## otherwise we get a vector of 0000s
</pre>
</div>

<pre class="example">
done.
</pre>


<p>
Quick peek
</p>

<div class="org-src-container">
<pre class="src src-bash">head ~/work/linkage/map/map.all.txt
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-right">Chr</td>
<td class="org-left">Name</td>
<td class="org-right">0.0</td>
<td class="org-right">0</td>
<td class="org-left">Name</td>
<td class="org-left">x</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-left">rs4475691</td>
<td class="org-right">0.0</td>
<td class="org-right">846808</td>
<td class="org-left">rs4475691</td>
<td class="org-left">x</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-left">rs9777703</td>
<td class="org-right">0.0</td>
<td class="org-right">928836</td>
<td class="org-left">rs9777703</td>
<td class="org-left">x</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-left">rs3128117</td>
<td class="org-right">0.0</td>
<td class="org-right">944564</td>
<td class="org-left">rs3128117</td>
<td class="org-left">x</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-left">rs7526076</td>
<td class="org-right">0.0</td>
<td class="org-right">998395</td>
<td class="org-left">rs7526076</td>
<td class="org-left">x</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-left">rs9442372</td>
<td class="org-right">0.0</td>
<td class="org-right">1018704</td>
<td class="org-left">rs9442372</td>
<td class="org-left">x</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-left">rs6687776</td>
<td class="org-right">0.0</td>
<td class="org-right">1030565</td>
<td class="org-left">rs6687776</td>
<td class="org-left">x</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-left">rs6671356</td>
<td class="org-right">0.0</td>
<td class="org-right">1040026</td>
<td class="org-left">rs6671356</td>
<td class="org-left">x</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-left">rs12092254</td>
<td class="org-right">0.0</td>
<td class="org-right">1113121</td>
<td class="org-left">rs12092254</td>
<td class="org-left">x</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-left">rs3813204</td>
<td class="org-right">0.0</td>
<td class="org-right">1121014</td>
<td class="org-left">rs3813204</td>
<td class="org-left">x</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>

<div id="outline-container-orga286999" class="outline-4">
<h4 id="orga286999">Check that the cM are in order</h4>
<div class="outline-text-4" id="text-orga286999">
<p>
We sorted by physical position, and though there is normally an easy correspondence between physical and genetic position &#x2013; there might be the odd cM position that is smaller than the one before it.
</p>

<p>
An easy way to do this is to take all cM positions and check if it's smaller than the one that proceeds it, except in the case where the chromosome changes (e.g. chr1:99997, chr1:99998, chr2:101). We would expect to see 22 <code>TRUE</code> values (12, 23, 34, &#x2026;, 22X).
</p>

<div class="org-src-container">
<pre class="src src-R">pos.cm &lt;- ordered.map$deCODE.cM.

pos.cm.compare &lt;- sapply(2:length(pos.cm), function(index){
  cm1 &lt;- pos.cm[[index - 1]]
  cm2 &lt;- pos.cm[[index]]

  return(cm1 &gt; cm2)  ## should be FALSE except when chrom changes
})
sum(pos.cm.compare)
</pre>
</div>

<pre class="example">
22
</pre>


<p>
Yay! Okay, we have a map we can use for linkage.
</p>
</div>
</div>


<div id="outline-container-org408f6fb" class="outline-4">
<h4 id="org408f6fb">Remove the outlier markers from the genotypes and maf file</h4>
<div class="outline-text-4" id="text-org408f6fb">
<p>
We only discovered the outlier markers during the map generation phase (note to self: generate the map first before the genotypes). So we need to remove these outlier markers from the genotypes and maf file.
</p>

<p>
First let's write out the outlier markers to file:
</p>

<div class="org-src-container">
<pre class="src src-R">write.table(markers.outliers, file="~/work/linkage/map/map.outliers", quote=F,
            col.names=F, row.names=F)
</pre>
</div>

<p>
Now let's remove any lines that match outliers. Let's do this in elisp because it's quicker (edit: that turned out to be a lie&#x2026;)
</p>

<div class="org-src-container">
<pre class="src src-elisp">
(let ((outliers nil))
  (labels ((getline () (buffer-substring-no-properties
                        (point)
                        (progn (forward-line 1) (point))))
           (process (oldfile newfile)
                    (let ((newbuff (get-buffer-create "tmp.buff"))
                          (counter 0))
                      (with-current-buffer newbuff (erase-buffer))
                      (with-current-buffer (find-file-noselect oldfile)
                        (goto-char 0)
                        (while (not (eobp))
                          (let* ((line (getline))
                                 (mark (car (split-string line "[	 ]" nil "[ \n]"))))
                            (if (not (member mark outliers))
                                (with-current-buffer newbuff (insert line))
                              (setq counter (1+ counter)))))
                        (message "Skipped %d markers" counter))
                      (with-current-buffer newbuff
                        (write-file newfile nil)))))
    ;; populate markers
    (with-current-buffer (find-file-noselect "~/work/linkage/map/map.outliers")
      (goto-char 0)
      (while (not (eobp))
        (push (string-trim (getline)) outliers))
      (kill-buffer))
    ;; parse genotypes
    (process "~/work/linkage/preprocessed/genotypes" "~/work/linkage/preprocessed/genotypes.new")
    ;; parse maf
    (process "~/work/linkage/preprocessed/maf.txt" "~/work/linkage/preprocessed/maf.txt.new")))
</pre>
</div>

<p>
And now a quick and final check to see how many lines / markers were removed from the genotypes and the maf:
</p>

<div class="org-src-container">
<pre class="src src-bash" id="orgee02ad6">diff -b $f1 $f1.new | grep "&lt;" | wc -l
</pre>
</div>

<p>
Genotypes:
</p>

<pre class="example">
471
</pre>


<p>
MAF:
</p>
<pre class="example">
471
</pre>


<p>
471 lines different in each file which corresponds to the 471 outliers removed from each file.
</p>

<p>
We can now proceed with the actual linkage analysis (tomorrow) <span class="timestamp-wrapper"><span class="timestamp">&lt;2020-06-20 Sat&gt;</span></span>
</p>
</div>
</div>
</div>
</div>




<div id="outline-container-orgc915200" class="outline-2">
<h2 id="orgc915200">Linkage Analysis (Attempts 1-3)</h2>
<div class="outline-text-2" id="text-orgc915200">
</div>
<div id="outline-container-org32c18c0" class="outline-3">
<h3 id="org32c18c0">Snpbutcher</h3>
<div class="outline-text-3" id="text-org32c18c0">
<p>
Here we subselect the map file for informative markers, using snpbutcher. It takes a maf file as input but we will ignore it since it's not necessary to use.
</p>

<p>
(here we work on remote machine)
</p>

<div class="org-src-container">
<pre class="src src-sh">cd /home/tetris/work/jobs_for_people/robert/118_canspanbrit/01_initial/
snpbutcher2.py map.all.txt maf.txt genotypes -z -nh &gt; map.txt
</pre>
</div>

<pre class="example">

$ /ssh:tetris@132.230.153.85:/home/tetris/work/ #$ [ARGS] Zero maf markers too, NOT using hapmap

[INFO] reading 'genotypes'...
[INFO] found 5952/214093 SNPs uninformative
[INFO] reading 'map.all.txt' and printing new map...
[INFO] chromosome 01 02 03 04 05 06 07 08 09 10 11 12 13 14 15 16 17 18 19 20 21 22 X
[INFO] new map contains 38570 SNPs
</pre>


<p>
We have 38,570 SNPs selected at a cM distance of 0.05.  The <code>-z</code> flag is used to essentially skip the maf file, and the <code>-nh</code> is used to not check against HapMap.
</p>
</div>
</div>


<div id="outline-container-org5ca706c" class="outline-3">
<h3 id="org5ca706c">Run1</h3>
<div class="outline-text-3" id="text-org5ca706c">
<div class="org-src-container">
<pre class="src src-sh">linkage_pipeline.sh
</pre>
</div>

<pre class="example">
[INFO] Checking Display...
Xserver available...? Yes: Remote, all graphical apps will be forwarded to you.
Xclient -&gt; Xserver..? Yes

[INFO] Checking Inputs...
[2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017, 2018, 2019, 2020, 2021, 2022, 2023, 2024, 2025, 2026, 2027, 2028, 2029, 2030, 2031, 2032, 2033, 2034, 2035, 2036, 2037, 2038, 2039, 2040, 2041, 2042, 2043, 2044, 2045, 2046, 2047, 2048, 2049, 2050, 2051, 2052, 2053, 2054, 2055, 2056, 2057, 2058, 2059, 2060, 21, 22, 44, 32, 61, 79, 57, 35, 97]
[Info] The following pedfile IDs are not in the genotypes file and have been specified as ungenotyped [76111, 76211, 76213, 76215, 76222, 7623, 7624, 76112, 76121, 76123]

[Warning] The following pedfile IDs were not in the genotypes file:
20

[Warning] The following genotypes were not used in the pedfile:
2001 2002 2003 2004 2005 2006 2007 2008 2009 2010 2011 2012 2013 2014 2015 2016 2017 2018 2019 2038 2039 2040 2041 2042 2043 2044 2045 2046 2047 2048 2049 2050 2051 2052 2053 2054 2055 2056 2057 2058 2059 2060 21
[Info] The following genotypes will be used:
22 32 35 44 57 61 79 97 2020 2021 2022 2023 2024 2025 2026 2027 2028 2029 2030 2031 2032 2033 2034 2035 2036 2037
</pre>
</div>

<div id="outline-container-orga03a0c5" class="outline-4">
<h4 id="orga03a0c5">Issues</h4>
<div class="outline-text-4" id="text-orga03a0c5">
<p>
Here we have hit some problems:
</p>

<ol class="org-ol">
<li>There is an individual <code>20</code> who is specified in the pedigree, but not in the genotypes</li>
<li>There is an individual <code>21</code> who is specified in the genotypes, but not in the pedigree</li>
<li>We have many individuals <code>2001 2002 2003 2004 2005 2006 2007 2008 2009 2010 2011 2012 2013 2014 2015 2016 2017 2018 2019 2038 2039 2040 2041 2042 2043 2044 2045 2046 2047 2048 2049 2050 2051 2052 2053 2054 2055 2056 2057 2058 2059 2060</code> who are never even used in the pedigree.</li>
</ol>


<p>
The first two can be resolved by swapping <code>20</code> with <code>21</code> in the pedigree, but then it begs the question of why this was not done for the paper. In the paper it seems like <code>21</code> was changed to <code>20</code> in the genotypes files, perhaps because of a sample mixup that was rectified? I need to ask Mallory.
</p>

<p>
The third issue means we need to regenerate the genotypes, and then regenerate the map file with <code>snpbutcher</code>. Uninformative markers are selected on the basis that an entire marker has the same genotype call across sampled individuals. By keeping in individuals not relevant to the analysis, we run the (small) risk of keeping markers in the analysis which are identical in our wanted individuals.
</p>

<p>
For example:
</p>

<table id="orgdcdf05c" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Name</th>
<th scope="col" class="org-left">blah</th>
<th scope="col" class="org-left">blah</th>
<th scope="col" class="org-left">blah</th>
<th scope="col" class="org-left">11</th>
<th scope="col" class="org-left">12</th>
<th scope="col" class="org-left">13</th>
<th scope="col" class="org-left">blah</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">rs123</td>
<td class="org-left">AB</td>
<td class="org-left">AB</td>
<td class="org-left">NC</td>
<td class="org-left">AB</td>
<td class="org-left">AB</td>
<td class="org-left">BB</td>
<td class="org-left">NC</td>
</tr>

<tr>
<td class="org-left">rs234</td>
<td class="org-left">AB</td>
<td class="org-left">AB</td>
<td class="org-left">AB</td>
<td class="org-left">AB</td>
<td class="org-left">AB</td>
<td class="org-left">AB</td>
<td class="org-left">AB</td>
</tr>

<tr>
<td class="org-left">rs345</td>
<td class="org-left">AB</td>
<td class="org-left">AB</td>
<td class="org-left">AB</td>
<td class="org-left">NC</td>
<td class="org-left">NC</td>
<td class="org-left">NC</td>
<td class="org-left">AB</td>
</tr>

<tr>
<td class="org-left">rs456</td>
<td class="org-left">AA</td>
<td class="org-left">AA</td>
<td class="org-left">AB</td>
<td class="org-left">AA</td>
<td class="org-left">AB</td>
<td class="org-left">BB</td>
<td class="org-left">BB</td>
</tr>
</tbody>
</table>

<p>
Snpbutcher when run on the whole table will only eliminate marker rs234, but rs345 also remains despite the fact that it is uninformative for the individuals in our pedigree (11, 12, 13)
</p>
</div>

<div id="outline-container-org91e7169" class="outline-5">
<h5 id="org91e7169">Resolution</h5>
<div class="outline-text-5" id="text-org91e7169">
<p>
I just spoke with Mallory <span class="timestamp-wrapper"><span class="timestamp">&lt;2020-06-20 Sat 23:26&gt;</span></span>, apparently 21 was a troublesome individual who reduced the linkage score, and that 20 was never genotypes &#x2013; so I should kick out both individuals 20 and 21 from the pedigree and genotypes
</p>
</div>
</div>
</div>

<div id="outline-container-org49b6b8c" class="outline-4">
<h4 id="org49b6b8c">Fixing the Input Files</h4>
<div class="outline-text-4" id="text-org49b6b8c">
</div>
<div id="outline-container-orgb069a1f" class="outline-5">
<h5 id="orgb069a1f">Fixing the Pedigree</h5>
<div class="outline-text-5" id="text-orgb069a1f">
</div>
<ul class="org-ul">
<li><a id="orgf83b622"></a>British<br />
<div class="outline-text-6" id="text-orgf83b622">
<p>
Change individual 20 to 7620
</p>

<div class="org-src-container">
<pre class="src src-text">1181	7623	0	0	1	1
1181	7624	0	0	2	1
1181	32	7623	7624	2	1
1181	22	7623	7624	2	1
1181	7620	0	0	1	1
1181	44	0	0	1	1
1181	79	7620	32	1	2
1181	61	7620	32	1	2
1181	35	44	22	2	1
1181	57	0	0	1	1
1181	97	57	35	1	2
</pre>
</div>
</div>
</li>

<li><a id="org7740776"></a>Spanish<br />
<div class="outline-text-6" id="text-org7740776">
<div class="org-src-container">
<pre class="src src-text">1182	76111	0	0	1	1
1182	76112	0	0	2	1
1182	76121	0	0	1	1
1182	2021	76111	76112	2	1
1182	2022	76111	76112	1	2
1182	2020	76121	2021	1	2
1182	76123	0	0	1	1
1182	2023	76123	2021	1	2
</pre>
</div>
</div>
</li>


<li><a id="org9f4e2c9"></a>Canadian<br />
<div class="outline-text-6" id="text-org9f4e2c9">
<div class="org-src-container">
<pre class="src src-text">1183	76211	0	0	1	1
1183	2037	0	0	2	1
1183	2033	76211	2037	1	1
1183	76222	0	0	2	1
1183	2036	2033	76222	1	1
1183	2035	2033	76222	1	1
1183	2034	76211	2037	1	2
1183	2032	76211	2037	2	1
1183	76213	0	0	1	1
1183	2026	76213	2032	1	1
1183	2030	76211	2037	2	1
1183	76215	0	0	1	1
1183	2028	76215	2030	2	1
1183	2027	76215	2030	1	1
1183	2029	0	0	1	1
1183	2031	76211	2037	2	1
1183	2024	2029	2031	2	1
1183	2025	2029	2031	1	2
</pre>
</div>
</div>
</li>

<li><a id="org2c35f57"></a>Consistency Check<br />
<div class="outline-text-6" id="text-org2c35f57">
<pre class="example">
7623	no mother as expected.	no father as expected.
7624	no mother as expected.	no father as expected.
32	7624 (mother,female) clear	7623 (father,male) clear
22	7624 (mother,female) clear	7623 (father,male) clear
7620	no mother as expected.	no father as expected.
44	no mother as expected.	no father as expected.
79	32 (mother,female) clear	7620 (father,male) clear
61	32 (mother,female) clear	7620 (father,male) clear
35	22 (mother,female) clear	44 (father,male) clear
57	no mother as expected.	no father as expected.
97	35 (mother,female) clear	57 (father,male) clear
76111	no mother as expected.	no father as expected.
76112	no mother as expected.	no father as expected.
76121	no mother as expected.	no father as expected.
2021	76112 (mother,female) clear	76111 (father,male) clear
2022	76112 (mother,female) clear	76111 (father,male) clear
2020	2021 (mother,female) clear	76121 (father,male) clear
76123	no mother as expected.	no father as expected.
2023	2021 (mother,female) clear	76123 (father,male) clear
76211	no mother as expected.	no father as expected.
2037	no mother as expected.	no father as expected.
2033	2037 (mother,female) clear	76211 (father,male) clear
76222	no mother as expected.	no father as expected.
2036	76222 (mother,female) clear	2033 (father,male) clear
2035	76222 (mother,female) clear	2033 (father,male) clear
2034	2037 (mother,female) clear	76211 (father,male) clear
2032	2037 (mother,female) clear	76211 (father,male) clear
76213	no mother as expected.	no father as expected.
2026	2032 (mother,female) clear	76213 (father,male) clear
2030	2037 (mother,female) clear	76211 (father,male) clear
76215	no mother as expected.	no father as expected.
2028	2030 (mother,female) clear	76215 (father,male) clear
2027	2030 (mother,female) clear	76215 (father,male) clear
2029	no mother as expected.	no father as expected.
2031	2037 (mother,female) clear	76211 (father,male) clear
2024	2031 (mother,female) clear	2029 (father,male) clear
2025	2031 (mother,female) clear	2029 (father,male) clear
</pre>

<p>
Pass check
</p>
</div>
</li>
</ul>
</div>
</div>


<div id="outline-container-orgd2d65d0" class="outline-4">
<h4 id="orgd2d65d0">Fixing the Genotypes</h4>
<div class="outline-text-4" id="text-orgd2d65d0">
<p>
Here we will remove <code>2001 2002 2003 2004 2005 2006 2007 2008 2009 2010 2011 2012 2013 2014 2015 2016 2017 2018 2019 2038 2039 2040 2041 2042 2043 2044 2045 2046 2047 2048 2049 2050 2051 2052 2053 2054 2055 2056 2057 2058 2059 2060 21</code>
</p>

<p>
Let us perform a quick check on the headers
</p>

<div class="org-src-container">
<pre class="src src-bash">head -1 ~/work/linkage/preprocessed/genotypes.new
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">Name</td>
<td class="org-left">X2001</td>
<td class="org-left">X2002</td>
<td class="org-left">X2003</td>
<td class="org-left">X2004</td>
<td class="org-left">X2005</td>
<td class="org-left">X2006</td>
<td class="org-left">X2007</td>
<td class="org-left">X2008</td>
<td class="org-left">X2009</td>
<td class="org-left">X2010</td>
<td class="org-left">X2011</td>
<td class="org-left">X2012</td>
<td class="org-left">X2013</td>
<td class="org-left">X2014</td>
<td class="org-left">X2015</td>
<td class="org-left">X2016</td>
<td class="org-left">X2017</td>
<td class="org-left">X2018</td>
<td class="org-left">X2019</td>
<td class="org-left">X2020</td>
<td class="org-left">X2021</td>
<td class="org-left">X2022</td>
<td class="org-left">X2023</td>
<td class="org-left">X2024</td>
<td class="org-left">X2025</td>
<td class="org-left">X2026</td>
<td class="org-left">X2027</td>
<td class="org-left">X2028</td>
<td class="org-left">X2029</td>
<td class="org-left">X2030</td>
<td class="org-left">X2031</td>
<td class="org-left">X2032</td>
<td class="org-left">X2033</td>
<td class="org-left">X2034</td>
<td class="org-left">X2035</td>
<td class="org-left">X2036</td>
<td class="org-left">X2037</td>
<td class="org-left">X2038</td>
<td class="org-left">X2039</td>
<td class="org-left">X2040</td>
<td class="org-left">X2041</td>
<td class="org-left">X2042</td>
<td class="org-left">X2043</td>
<td class="org-left">X2044</td>
<td class="org-left">X2045</td>
<td class="org-left">X2046</td>
<td class="org-left">X2047</td>
<td class="org-left">X2048</td>
<td class="org-left">X2049</td>
<td class="org-left">X2050</td>
<td class="org-left">X2051</td>
<td class="org-left">X2052</td>
<td class="org-left">X2053</td>
<td class="org-left">X2054</td>
<td class="org-left">X2055</td>
<td class="org-left">X2056</td>
<td class="org-left">X2057</td>
<td class="org-left">X2058</td>
<td class="org-left">X2059</td>
<td class="org-left">X2060</td>
<td class="org-left">X21</td>
<td class="org-left">X22</td>
<td class="org-left">X44</td>
<td class="org-left">X32</td>
<td class="org-left">X61</td>
<td class="org-left">X79</td>
<td class="org-left">X57</td>
<td class="org-left">X35</td>
<td class="org-left">X97</td>
</tr>
</tbody>
</table>


<p>
(Let's also strip the 'X's from the headers)
</p>

<div class="org-src-container">
<pre class="src src-bash">sed -i.bak '1 s|X||g' ~/work/linkage/preprocessed/genotypes.new
head -1 ~/work/linkage/preprocessed/genotypes.new
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<tbody>
<tr>
<td class="org-left">Name</td>
<td class="org-right">2001</td>
<td class="org-right">2002</td>
<td class="org-right">2003</td>
<td class="org-right">2004</td>
<td class="org-right">2005</td>
<td class="org-right">2006</td>
<td class="org-right">2007</td>
<td class="org-right">2008</td>
<td class="org-right">2009</td>
<td class="org-right">2010</td>
<td class="org-right">2011</td>
<td class="org-right">2012</td>
<td class="org-right">2013</td>
<td class="org-right">2014</td>
<td class="org-right">2015</td>
<td class="org-right">2016</td>
<td class="org-right">2017</td>
<td class="org-right">2018</td>
<td class="org-right">2019</td>
<td class="org-right">2020</td>
<td class="org-right">2021</td>
<td class="org-right">2022</td>
<td class="org-right">2023</td>
<td class="org-right">2024</td>
<td class="org-right">2025</td>
<td class="org-right">2026</td>
<td class="org-right">2027</td>
<td class="org-right">2028</td>
<td class="org-right">2029</td>
<td class="org-right">2030</td>
<td class="org-right">2031</td>
<td class="org-right">2032</td>
<td class="org-right">2033</td>
<td class="org-right">2034</td>
<td class="org-right">2035</td>
<td class="org-right">2036</td>
<td class="org-right">2037</td>
<td class="org-right">2038</td>
<td class="org-right">2039</td>
<td class="org-right">2040</td>
<td class="org-right">2041</td>
<td class="org-right">2042</td>
<td class="org-right">2043</td>
<td class="org-right">2044</td>
<td class="org-right">2045</td>
<td class="org-right">2046</td>
<td class="org-right">2047</td>
<td class="org-right">2048</td>
<td class="org-right">2049</td>
<td class="org-right">2050</td>
<td class="org-right">2051</td>
<td class="org-right">2052</td>
<td class="org-right">2053</td>
<td class="org-right">2054</td>
<td class="org-right">2055</td>
<td class="org-right">2056</td>
<td class="org-right">2057</td>
<td class="org-right">2058</td>
<td class="org-right">2059</td>
<td class="org-right">2060</td>
<td class="org-right">21</td>
<td class="org-right">22</td>
<td class="org-right">44</td>
<td class="org-right">32</td>
<td class="org-right">61</td>
<td class="org-right">79</td>
<td class="org-right">57</td>
<td class="org-right">35</td>
<td class="org-right">97</td>
</tr>
</tbody>
</table>

<p>
We want to skip columns <code>1-19</code>, <code>38-60</code>, <code>61</code> (+1 to all numbers to the left)
</p>

<div class="org-src-container">
<pre class="src src-bash">cut --complement -f 2-20,39-61,62 ~/work/linkage/preprocessed/genotypes.new &gt; ~/work/linkage/second/genotypes.new
head -2 ~/work/linkage/second/genotypes.new
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<tbody>
<tr>
<td class="org-left">Name</td>
<td class="org-right">2020</td>
<td class="org-right">2021</td>
<td class="org-right">2022</td>
<td class="org-right">2023</td>
<td class="org-right">2024</td>
<td class="org-right">2025</td>
<td class="org-right">2026</td>
<td class="org-right">2027</td>
<td class="org-right">2028</td>
<td class="org-right">2029</td>
<td class="org-right">2030</td>
<td class="org-right">2031</td>
<td class="org-right">2032</td>
<td class="org-right">2033</td>
<td class="org-right">2034</td>
<td class="org-right">2035</td>
<td class="org-right">2036</td>
<td class="org-right">2037</td>
<td class="org-right">22</td>
<td class="org-right">44</td>
<td class="org-right">32</td>
<td class="org-right">61</td>
<td class="org-right">79</td>
<td class="org-right">57</td>
<td class="org-right">35</td>
<td class="org-right">97</td>
</tr>

<tr>
<td class="org-left">rs1000002</td>
<td class="org-right">BB</td>
<td class="org-right">AB</td>
<td class="org-right">AA</td>
<td class="org-right">BB</td>
<td class="org-right">AB</td>
<td class="org-right">BB</td>
<td class="org-right">AB</td>
<td class="org-right">AA</td>
<td class="org-right">AB</td>
<td class="org-right">BB</td>
<td class="org-right">AB</td>
<td class="org-right">AB</td>
<td class="org-right">AB</td>
<td class="org-right">AB</td>
<td class="org-right">AB</td>
<td class="org-right">AB</td>
<td class="org-right">BB</td>
<td class="org-right">BB</td>
<td class="org-right">AB</td>
<td class="org-right">AB</td>
<td class="org-right">AB</td>
<td class="org-right">AB</td>
<td class="org-right">BB</td>
<td class="org-right">AB</td>
<td class="org-right">BB</td>
<td class="org-right">BB</td>
</tr>
</tbody>
</table>
</div>
</div>


<div id="outline-container-org6ef19fd" class="outline-4">
<h4 id="org6ef19fd">Generating New Map file</h4>
<div class="outline-text-4" id="text-org6ef19fd">
<p>
(copied over files in <code>second</code> dir to work machine <code>02_second</code> folder)
</p>


<p>
Map and maf file as before.
</p>


<div class="org-src-container">
<pre class="src src-sh">cd /home/tetris/work/jobs_for_people/robert/118_canspanbrit/02_second
snpbutcher2.py map.all.txt maf.txt genotypes -z -nh &gt; map.txt
</pre>
</div>

<pre class="example">

$ [ARGS] Zero maf markers too, NOT using hapmap

[INFO] reading 'genotypes'...
[INFO] found 15607/214093 SNPs uninformative
[INFO] reading 'map.all.txt' and printing new map...
[INFO] chromosome 01 02 03 04 05 06 07 08 09 10 11 12 13 14 15 16 17 18 19 20 21 22 X
[INFO] new map contains 37968 SNPs
</pre>


<p>
37,968 markers, which is less than the 38,570 we had before. Again, this is expected since the markers now have a higher change of being NC across all samples if the number of samples is reduced.
</p>
</div>
</div>
</div>


<div id="outline-container-org9e05c6a" class="outline-3">
<h3 id="org9e05c6a">Run 2</h3>
<div class="outline-text-3" id="text-org9e05c6a">
<p>
<code>bitscore.py</code> computed that the largest family (1183) has 18 bits.
</p>

<ul class="org-ul">
<li>Small notes:
<ul class="org-ul">
<li>I ran out of storage on my work machine so I moved to an external hd.</li>
<li>Memory peaked on c01 for allegro at 10GB</li>
</ul></li>
</ul>
</div>

<div id="outline-container-orgca98010" class="outline-4">
<h4 id="orgca98010">rs211641 Error on chrX</h4>
<div class="outline-text-4" id="text-orgca98010">
<p>
It threw an inconsistent genotypes error at <code>rs211641</code> for family 1181:
</p>

<table id="orgb485a25" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<tbody>
<tr>
<td class="org-right">1181</td>
<td class="org-right">7623</td>
<td class="org-right">0</td>
<td class="org-right">0</td>
<td class="org-right">1</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-right">1181</td>
<td class="org-right">32</td>
<td class="org-right">7623</td>
<td class="org-right">7624</td>
<td class="org-right">2</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-right">1181</td>
<td class="org-right">22</td>
<td class="org-right">7623</td>
<td class="org-right">7624</td>
<td class="org-right">2</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-right">1181</td>
<td class="org-right">7620</td>
<td class="org-right">0</td>
<td class="org-right">0</td>
<td class="org-right">1</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-right">1181</td>
<td class="org-right">44</td>
<td class="org-right">0</td>
<td class="org-right">0</td>
<td class="org-right">1</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-right">1181</td>
<td class="org-right">79</td>
<td class="org-right">7620</td>
<td class="org-right">32</td>
<td class="org-right">1</td>
<td class="org-right">2</td>
</tr>

<tr>
<td class="org-right">1181</td>
<td class="org-right">61</td>
<td class="org-right">7620</td>
<td class="org-right">32</td>
<td class="org-right">1</td>
<td class="org-right">2</td>
</tr>

<tr>
<td class="org-right">1181</td>
<td class="org-right">35</td>
<td class="org-right">44</td>
<td class="org-right">22</td>
<td class="org-right">2</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-right">1181</td>
<td class="org-right">57</td>
<td class="org-right">0</td>
<td class="org-right">0</td>
<td class="org-right">1</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-right">1181</td>
<td class="org-right">97</td>
<td class="org-right">57</td>
<td class="org-right">35</td>
<td class="org-right">1</td>
<td class="org-right">2</td>
</tr>
</tbody>
</table>


<p>
Let us extract the genotypes for that marker
</p>

<div class="org-src-container">
<pre class="src src-bash">head -1 /mnt/robert/118_canspanbrit/02_second/genotypes
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<tbody>
<tr>
<td class="org-left">Name</td>
<td class="org-right">2020</td>
<td class="org-right">2021</td>
<td class="org-right">2022</td>
<td class="org-right">2023</td>
<td class="org-right">2024</td>
<td class="org-right">2025</td>
<td class="org-right">2026</td>
<td class="org-right">2027</td>
<td class="org-right">2028</td>
<td class="org-right">2029</td>
<td class="org-right">2030</td>
<td class="org-right">2031</td>
<td class="org-right">2032</td>
<td class="org-right">2033</td>
<td class="org-right">2034</td>
<td class="org-right">2035</td>
<td class="org-right">2036</td>
<td class="org-right">2037</td>
<td class="org-right">22</td>
<td class="org-right">44</td>
<td class="org-right">32</td>
<td class="org-right">61</td>
<td class="org-right">79</td>
<td class="org-right">57</td>
<td class="org-right">35</td>
<td class="org-right">97</td>
</tr>
</tbody>
</table>

<ul class="org-ul">
<li>32 - col: 22</li>
<li>22 - col: 20</li>
<li>44 - col: 21</li>
<li>79 - col: 24</li>
<li>61 - col: 23</li>
<li>35 - col: 26</li>
<li>57 - col: 25</li>
<li><p>
97 - col: 27
</p>

<div class="org-src-container">
<pre class="src src-bash">cut -f 1,20-27 /mnt/robert/118_canspanbrit/02_second/genotypes | head -1
cut -f 1,20-27 /mnt/robert/118_canspanbrit/02_second/genotypes | grep rs211641
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<tbody>
<tr>
<td class="org-left">Name</td>
<td class="org-right">22</td>
<td class="org-right">44</td>
<td class="org-right">32</td>
<td class="org-right">61</td>
<td class="org-right">79</td>
<td class="org-right">57</td>
<td class="org-right">35</td>
<td class="org-right">97</td>
</tr>

<tr>
<td class="org-left">rs211641</td>
<td class="org-right">AB</td>
<td class="org-right">AA</td>
<td class="org-right">AB</td>
<td class="org-right">BB</td>
<td class="org-right">AA</td>
<td class="org-right">BB</td>
<td class="org-right">AA</td>
<td class="org-right">AA</td>
</tr>
</tbody>
</table></li>
</ul>
</div>


<div id="outline-container-org59a1ec4" class="outline-5">
<h5 id="org59a1ec4">rs211641 in the pedigree 1181</h5>
<div class="outline-text-5" id="text-org59a1ec4">
<p>
Okay now let's see how these genotypes look on the pedigree (I will just draw it in ascii below, where for each pair: Males on Left and Females on Right)
</p>


<div class="org-src-container">
<pre class="src src-artist">             7623[XY] --- 7624[XX]
                       |
              _________|_____________
             |                       |
7620[XY] --- 32[XX]      44[XY] --- 22[XX]
          |                      |
      ____|___                   |
     |        |      57[XY] --- 35[XX]
 *79[XY    *61[XY]           |
                           *97[XY]
</pre>
</div>

<p>
Here I have made a small drawing of the pedigree for family 1181, with males given as <code>XY</code> and females as <code>XX</code>, with affected individuals given a *.
</p>

<p>
Let's fill in the XY/XX with the genotypes from the above table.
</p>

<div class="org-src-container">
<pre class="src src-artist">             7623[XY] --- 7624[XX]
                       |
              _________|_____________
             |                       |
7620[XY] --- 32[AB]      44[AA] --- 22[AB]
          |                      |
      ____|___                   |
     |        |      57[BB] --- 35[AA]
 *79[AA]    *61[BB]           |
                           *97[AA]
</pre>
</div>

<p>
So given that the <code>Y</code> chromosome can only come from the father, and one of the <code>X</code>'s from the mother, let us look for any inconsistencies.
</p>

<p>
We can actually see two:
</p>
<dl class="org-dl">
<dt>7620  79 and 61</dt><dd>These are all males, so the offspring should share at least 1 allele, but the GT calls for the offspring are <code>AA</code> and <code>BB</code> which means they cannot share the same father.</dd>
<dt>57  97</dt><dd>Again, both males and yet not a single allele appears to be shared between them</dd>
</dl>


<p>
From this we can conclude that allegro is correct in saying that this marker is inconsistent. What we can do next is remove this marker and then rerun the entire analysis (~ 2hrs), but there will likely be other markers which are inconsistent and this will be very slow to debug.
</p>

<p>
While I rerun this again (without rs211641) I will try to write my own parser to validate these kinds of genotypes
</p>
</div>
</div>
</div>

<div id="outline-container-org3d3968c" class="outline-4">
<h4 id="org3d3968c">Rerun without rs211641</h4>
<div class="outline-text-4" id="text-org3d3968c">
<p>
Remove this marker from current map, maf, and genotypes. Currently we have:
</p>

<div class="org-src-container">
<pre class="src src-bash">wc -l /mnt/robert/118_canspanbrit/02_second/{genotypes,maf.txt,map.txt}
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-right">214093</td>
<td class="org-left">/mnt/robert/118<sub>canspanbrit</sub>/02<sub>second</sub>/genotypes</td>
</tr>

<tr>
<td class="org-right">214093</td>
<td class="org-left">/mnt/robert/118<sub>canspanbrit</sub>/02<sub>second</sub>/maf.txt</td>
</tr>

<tr>
<td class="org-right">37969</td>
<td class="org-left">/mnt/robert/118<sub>canspanbrit</sub>/02<sub>second</sub>/map.txt</td>
</tr>
</tbody>
</table>

<p>
and now if we remove one marker, we have:
</p>

<div class="org-src-container">
<pre class="src src-bash">newdir=/mnt/robert/118_canspanbrit/03_nors211641
mkdir -p $newdir
cp /mnt/robert/118_canspanbrit/02_second/pedfile.pro $newdir/pedfile.pro
cat /mnt/robert/118_canspanbrit/02_second/genotypes | grep -v rs211641 &gt; $newdir/genotypes
cat /mnt/robert/118_canspanbrit/02_second/map.txt | grep -v rs211641 &gt; $newdir/map.txt
cat /mnt/robert/118_canspanbrit/02_second/maf.txt | grep -v rs211641 &gt; $newdir/maf.txt
wc -l $newdir/{genotypes,maf.txt,map.txt}
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-right">214092</td>
<td class="org-left">/mnt/robert/118<sub>canspanbrit</sub>/03<sub>nors211641</sub>/genotypes</td>
</tr>

<tr>
<td class="org-right">214092</td>
<td class="org-left">/mnt/robert/118<sub>canspanbrit</sub>/03<sub>nors211641</sub>/maf.txt</td>
</tr>

<tr>
<td class="org-right">37968</td>
<td class="org-left">/mnt/robert/118<sub>canspanbrit</sub>/03<sub>nors211641</sub>/map.txt</td>
</tr>
</tbody>
</table>

<p>
1 line less, good.
</p>

<p>
Okay now we can rerun the whole pipeline again. There is a small issue that wine cannot see a mounted volume so let's link it to a directory in home and run it from there
</p>

<div class="org-src-container">
<pre class="src src-bash">ln -s /mnt/robert/118_canspanbrit/03_nors211641 /home/tetris/work/jobs_for_people/robert/118_canspanbrit/03_nors211641
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org92c54d2" class="outline-3">
<h3 id="org92c54d2">Run 3 (without rs211641)</h3>
<div class="outline-text-3" id="text-org92c54d2">
</div>
<div id="outline-container-orgab8803f" class="outline-5">
<h5 id="orgab8803f">GRR notes</h5>
<div class="outline-text-5" id="text-orgab8803f">
<p>
I thought I saw some weird things in GRR. Not overly weird, but perhaps potential clues to the inconsistent markers.
Edit: Nope, it just appears that the Y chromosome clusters separately from the X, which is expected.
</p>
</div>

<ul class="org-ul">
<li><a id="org02b674e"></a>Family 1183 (Canadian)<br />
<div class="outline-text-6" id="text-org02b674e">

<div id="orgd7d0b01" class="figure">
<p><img src="./imgs/grr_screenshot_03_nors211641-family-1183.png" alt="grr_screenshot_03_nors211641-family-1183.png" />
</p>
<p><span class="figure-number">Figure 1: </span>Family 1183</p>
</div>


<p>
Ideally, all the different kinds of relationships (Siblings, Half-siblings, Parent-Child, Unrelated, and Other) should all cluster separately from one another without any mixing. From image <a href="#org949ec9c">2</a> we can see that there this one yellow (Parent-offspring) neighbouring the Sib-pairs, hinting that this particular relationship has been mislabelled.
</p>

<p>
For reference, a parent-offspring relationship expects roughly 50% of the genotypes to be shared from one individual to another, whereas siblings would expect to share a much higher proportion.
</p>

<p>
So here in this red cluster we have 3 yellow dots which reference the relationship between the following individuals:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">Person1</th>
<th scope="col" class="org-right">Person2</th>
<th scope="col" class="org-left">Relationship</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">2029</td>
<td class="org-right">2025</td>
<td class="org-left">father-son</td>
</tr>

<tr>
<td class="org-right">2033</td>
<td class="org-right">2036</td>
<td class="org-left">father-son</td>
</tr>

<tr>
<td class="org-right">2033</td>
<td class="org-right">2035</td>
<td class="org-left">father-son</td>
</tr>
</tbody>
</table>

<p>
And if we look at the other yellow dot cluster underneath this, this is made up of the following relationships:
</p>

<div class="org-src-container">
<pre class="src src-bash">cat /mnt/robert/118_canspanbrit/03_nors211641/test.txt | sed  's|1183-&gt;||g' | awk '{print $1"\t"$2"\t"$NF}'
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">Person1</th>
<th scope="col" class="org-right">Person2</th>
<th scope="col" class="org-left">Relationship</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">2031</td>
<td class="org-right">2037</td>
<td class="org-left">daughter-mother</td>
</tr>

<tr>
<td class="org-right">2024</td>
<td class="org-right">2031</td>
<td class="org-left">daughter-mother</td>
</tr>

<tr>
<td class="org-right">2033</td>
<td class="org-right">2037</td>
<td class="org-left">son-mother</td>
</tr>

<tr>
<td class="org-right">2034</td>
<td class="org-right">2037</td>
<td class="org-left">son-mother</td>
</tr>

<tr>
<td class="org-right">2032</td>
<td class="org-right">2037</td>
<td class="org-left">daughter-mother</td>
</tr>

<tr>
<td class="org-right">2030</td>
<td class="org-right">2037</td>
<td class="org-left">daughter-mother</td>
</tr>

<tr>
<td class="org-right">2028</td>
<td class="org-right">2030</td>
<td class="org-left">daughter-mother</td>
</tr>

<tr>
<td class="org-right">2026</td>
<td class="org-right">2032</td>
<td class="org-left">son-mother</td>
</tr>

<tr>
<td class="org-right">2024</td>
<td class="org-right">2029</td>
<td class="org-left">daughter-father</td>
</tr>

<tr>
<td class="org-right">2025</td>
<td class="org-right">2031</td>
<td class="org-left">son-mother</td>
</tr>

<tr>
<td class="org-right">2027</td>
<td class="org-right">2030</td>
<td class="org-left">son-mother</td>
</tr>
</tbody>
</table>


<p>
Okay so from this we can conclude two things:
</p>

<ol class="org-ol">
<li>That father-son relationships cluster separately from mother-son/mother-daughter/father-daughter relationships.</li>
<li>That father-son relationships softly cluster with the sib-pair relationships</li>
</ol>


<p>
Why might this be? Well, recombination in the Y-chromosome is not expected, so it actually kind of makes sense that father's and son's would share more than 50% of their genotypes if the Y allele is unbroken.
</p>
</div>
</li>


<li><a id="org3b84385"></a>Family 1181 (British)<br />
<div class="outline-text-6" id="text-org3b84385">
<p>
In this family we again see a yellow dot softly clustering within the reds:
</p>


<div id="org949ec9c" class="figure">
<p><img src="./imgs/grr_screenshot_03_nors211641-family-1181.png" alt="grr_screenshot_03_nors211641-family-1181.png" />
</p>
<p><span class="figure-number">Figure 2: </span>Family 1181</p>
</div>

<p>
If we take a closer look:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">Person1</th>
<th scope="col" class="org-right">Person2</th>
<th scope="col" class="org-left">Relationship</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">57</td>
<td class="org-right">97</td>
<td class="org-left">father-son</td>
</tr>
</tbody>
</table>


<p>
And the yellow dots that cluster separately below it:
</p>


<div class="org-src-container">
<pre class="src src-bash">cat /mnt/robert/118_canspanbrit/03_nors211641/test2.txt | sed  's|1181-&gt;||g' | awk '{print $1"\t"$2"\t"$NF}'
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">Person1</th>
<th scope="col" class="org-right">Person2</th>
<th scope="col" class="org-left">Relationship</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">35</td>
<td class="org-right">97</td>
<td class="org-left">mother-son</td>
</tr>

<tr>
<td class="org-right">32</td>
<td class="org-right">79</td>
<td class="org-left">mother-son</td>
</tr>

<tr>
<td class="org-right">32</td>
<td class="org-right">61</td>
<td class="org-left">mother-son</td>
</tr>

<tr>
<td class="org-right">22</td>
<td class="org-right">35</td>
<td class="org-left">mother-daughter</td>
</tr>

<tr>
<td class="org-right">35</td>
<td class="org-right">44</td>
<td class="org-left">mother-son</td>
</tr>
</tbody>
</table>

<p>
So again, we see Y-chromosome cluster's separately from the X.
</p>
</div>
</li>
</ul>
</div>


<div id="outline-container-org5b12ec4" class="outline-5">
<h5 id="org5b12ec4">rs5983047 Error on chrX</h5>
<div class="outline-text-5" id="text-org5b12ec4">
<p>
This time the inconsistent marker appeared at position <code>rs5983047</code> for family 1181. Let us again look at the genotypes of this marker in scope of the pedigree.
</p>

<div class="org-src-container">
<pre class="src src-bash">cut -f 1,20-27 /mnt/robert/118_canspanbrit/03_nors211641/genotypes | head -1
cut -f 1,20-27 /mnt/robert/118_canspanbrit/03_nors211641/genotypes | grep rs5983047
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<tbody>
<tr>
<td class="org-left">Name</td>
<td class="org-right">22</td>
<td class="org-right">44</td>
<td class="org-right">32</td>
<td class="org-right">61</td>
<td class="org-right">79</td>
<td class="org-right">57</td>
<td class="org-right">35</td>
<td class="org-right">97</td>
</tr>

<tr>
<td class="org-left">rs5983047</td>
<td class="org-right">AB</td>
<td class="org-right">BB</td>
<td class="org-right">BB</td>
<td class="org-right">BB</td>
<td class="org-right">BB</td>
<td class="org-right">AA</td>
<td class="org-right">BB</td>
<td class="org-right">BB</td>
</tr>
</tbody>
</table>

<p>
(ordering: Males on the left, and Females on the right)
</p>

<div class="org-src-container">
<pre class="src src-artist">             7623[XY] --- 7624[XX]
                       |
              _________|_____________
             |                       |
7620[XY] --- 32[BB]      44[BB] --- 22[AB]
          |                      |
      ____|___                   |
     |        |      57[AA] --- 35[BB]
 *79[BB]    *61[BB]          |
                           *97[BB]
</pre>
</div>

<p>
I only see one violation which is the <code>57</code> to <code>97</code> (father-son) where the Y chromosome should be inherited (at least one <code>A</code>) but we see <code>BB</code> instead, so this is definitely a violation.
</p>

<p>
Sure I could repeat the analysis without rs5983047, but I really should parse all father-son relationships and see which markers are inconsistent.
</p>
</div>
</div>
</div>
</div>


<div id="outline-container-orgc01c751" class="outline-2">
<h2 id="orgc01c751">Remove inconsistent X-linked Markers</h2>
<div class="outline-text-2" id="text-orgc01c751">
<p>
We could just limit ourselves to examining father-son relationships, but it would likely be more useful to look for <i>any</i> marker inconsistency between parents and siblings. This actually is something that Merlin should do already, but it's likely that it fails to do this for the X chromosome. Again, we could just limit ourselves to father-son relationships on the just the X-chromosome, but we want to be thorough.
</p>

<p>
The genotypes file we will use will be the original one, so that we can check that <code>rs211641</code> and <code>rs5983047</code> are detected by my parser.
</p>
</div>

<div id="outline-container-orgb6c9c6c" class="outline-3">
<h3 id="orgb6c9c6c">Parse the Pedigree</h3>
<div class="outline-text-3" id="text-orgb6c9c6c">
<p>
Here we will reuse some code from the <a href="#orgab12ca3">above code</a>, and use the latest pedigree from <code>03_nors211641</code>.
</p>

<div class="org-src-container">
<pre class="src src-elisp">(setq pedigree nil)
(with-current-buffer (find-file-noselect "/ssh:tetris@132.230.153.85:/home/tetris/work/jobs_for_people/robert/118_canspanbrit/03_nors211641/pedfile.pro")
  (goto-char (point-min))
  (while (not (eobp))
    (let* ((nilornot (lambda (x) (unless (eq x 0) x)))
           (lvals (--map (string-to-number it)
                         (split-string
                          (buffer-substring-no-properties
                           (point)
                           (progn (forward-line 1) (point)))
                          "[	 ]" nil "[ \n]")))
           (entry (list (cadr lvals) ;; id -- alist
                        :family (car lvals)
                        :father (funcall nilornot (nth 2 lvals))
                        :mother (funcall nilornot (nth 3 lvals))
                        :gender (cond ((eq (nth 4 lvals) 0) 'unknown)
                                      ((eq (nth 4 lvals) 1) 'male)
                                      ((eq (nth 4 lvals) 2) 'female)
                                      (t (user-error "Gender error")))
                        :affect (cond ((eq (nth 5 lvals) 0) 'unknown)
                                      ((eq (nth 5 lvals) 1) 'yes)
                                      ((eq (nth 5 lvals) 2) 'no)
                                      (t (user-error "affected error"))))))
      (push entry pedigree))))
;; check duplicate ids
(let* ((ids (mapcar 'identity pedigree))
       (lenids (length ids))
       (uniqids (-uniq ids))
       (lenuniq (length uniqids)))
  (unless (eq lenids lenuniq)
    (user-error "Id's in pedfile are not unique: %s" (-difference ids uniqids))))
;; Check gender and parentage
(cl-labels ((checkparent (idp relation)
                         (let* ((id-data (alist-get idp pedigree))
                                (gender (plist-get id-data :gender)))
                           (if (not idp) (format "no %s as expected." relation)
                             (unless id-data (user-error "%id: %d (%s) does not exist " id idp relation))
                             (cond ((and (eq relation 'mother) (not (eq gender 'female)))
                                    (user-error "%d: %d (%s) is not female, but %s" id idp relation gender))
                                   ((and (eq relation 'father) (not (eq gender 'male)))
                                    (user-error "%d: %d (%s) is not male, but %s" id idp relation gender))
                                   (t (format "%d (%s,%s) clear" idp relation gender)))))))
  ;; recursion would be expensive, simple loop would suffice
  (let ((res nil))
    (dolist (entry pedigree)
      (let ((id (car entry))
            (mother (plist-get (cdr entry) :mother))
            (father (plist-get (cdr entry) :father)))
        (checkparent mother 'mother)
        (checkparent father 'father)))))
</pre>
</div>

<p>
So from this pedigree we will need to look for:
</p>
<ol class="org-ol">
<li>A trio of mother-father-child who are all genotyped (and then check the child against each parent)</li>
<li>Two males in a family (if they don't share an alelle, we flag them)</li>
</ol>


<p>
To find these, we need to do a second pass where we identify siblings. These will be useful in comparing the compatibility of genotypes across males sharing the same father.
</p>


<div class="org-src-container">
<pre class="src src-elisp">(dolist (indata pedigree)
  (let* ((indiv (car indata))
         (restd (cdr indata))
         (gender (plist-get restd :gender))
         (father (plist-get restd :father))
         (mother (plist-get restd :mother))
         ;; Find siblings
         (siblings (--map (cons (car it) (plist-get (cdr it) :gender))
                          (--filter (and (not (eq (car it) indiv)) ;; not the same indiv
                                         (eq (plist-get (cdr it) :father) father)
                                         (eq (plist-get (cdr it) :mother) mother))
                                    pedigree)))
         (brothers (-map #'car (--filter (eq 'male (cdr it)) siblings)))
         (sisters (-map #'car (--filter (eq 'female (cdr it)) siblings))))
    ;;
    (if (and mother father)  ;; not a founder
        (setf indata (list indiv (plist-put
                                  (plist-put restd :sisters sisters)
                                  :brothers brothers))))))
;; Quick check on two random individual
(concat
 (format "%s" (nth 2 pedigree)) "\n"
 (format "%s" (nth 3 pedigree)))
</pre>
</div>

<pre class="example">
"(2031 :family 1183 :father 76211 :mother 2037 :gender female :affect yes :sisters (2030 2032) :brothers (2034 2033))
(2029 :family 1183 :father nil :mother nil :gender male :affect yes)"
</pre>



<p>
Okay, so a founder individual <code>2029</code> has no siblings, and individual <code>2031</code> has 2 sisters and 2 brothers. Right, so it works.
</p>
</div>
</div>

<div id="outline-container-orgcb3f529" class="outline-3">
<h3 id="orgcb3f529">Parse the Genotypes</h3>
<div class="outline-text-3" id="text-orgcb3f529">
<p>
The pedigree is populated, but we need to iterate through the genotypes. Due to how large the file is, we can't load the entire file to memory, but luckily we don't have to since we only need to check that genotypes are consistent across a single marker. So we will simply read through this file line-by-line.
</p>

<p>
As mentioned previously, we will use the genotypes from <code>02_second/</code> where we have not kicked out any inconsistent markers (<code>rs211641</code> and <code>rs5983047</code>) as a validation for our method.
</p>
</div>

<div id="outline-container-org4a5525b" class="outline-5">
<h5 id="org4a5525b">Method</h5>
<div class="outline-text-5" id="text-org4a5525b">
<div class="org-src-container">
<pre class="src src-elisp" id="orgf6a2fb3">(cl-labels ((readtokens () (split-string (buffer-substring-no-properties
                                          (point)
                                          (progn (forward-line 1) (point)))
                                         "[	 ]" nil "[ \n]"))
            (unitealleles (allpairs) (format "%s%s" (car allpairs) (cadr allpairs)))
            (atleastone? (alleles parentid relationship)
                         (--&gt; (alist-get parentid genobind)
                              (unless (or (member (car alleles) it)
                                          (member (cadr alleles) it))
                                ;; 1 allele not inherited
                                (let ((newinf (list :relation (list relationship parentid id)
                                                    :alleles (list (unitealleles it) (unitealleles alleles))))
                                      (existing (alist-get marker error-markers)))
                                  (if existing
                                      (setf (alist-get marker error-markers)
                                            (append existing (list newinf)))
                                    ;; Otherwise push new
                                    (push (list marker newinf) error-markers)))))))
  (with-current-buffer (find-file-noselect filename)
    (goto-char (point-min))
    (let ((headers (-map #'string-to-number (cdr (readtokens))))
          (error-markers nil))
      (while (not (eobp))
      ;;(while (&lt;= (length error-markers) 10)
        (let* ((linedata (readtokens))
               (marker (car linedata))
               (genobind nil))
          (if (gethash marker chromX)
              ;; convert genotypes from strings to symbols ("AB" to (A . B))
              (let* ((genotypes (--map (if it (list (intern (car it)) (intern (cadr it))))
                                       (--map (if (string= "NC" it) nil
                                                (split-string it "" t))
                                              (cdr linedata))))
                     ;; Each line will be bound to the header (e.g. 2020 . AA, 2022 . BB)
                     (genobind (--zip-with (cons it other) headers genotypes)))
                ;; Now we iterate through the individuals
                (dolist (indiv genobind)
                  (let* ((id (car indiv))
                         (alleles (cdr indiv))
                         ;; pedigree info
                         (indiv-info (alist-get id pedigree))
                         (gender (plist-get indiv-info :gender))
                         (mother (plist-get indiv-info :mother))
                         (father (plist-get indiv-info :father))
                         (sisters (plist-get indiv-info :sisters))
                         (brothers (plist-get indiv-info :brothers)))
                    ;;
                    (if alleles  ;; NC we ignore
                        (cond ((eq gender 'male)
                               ;; If male, check brothers and fathers
                               (if (and father (alist-get father genobind))
                                   ;; At this point we could check all brothers against their father's types
                                   ;; too, but note that we will effectively do this in later iterations
                                   ;; when the individual becomes one of the brothers.
                                   (atleastone? alleles father "father-son")
                                 ;;
                                 ;; If no father, check against brothers
                                 (dolist (bro brothers)
                                   (if (alist-get bro genobind)  ;; NC we ignore
                                       (atleastone? alleles bro "brother-brother")))))
                              ;;
                              ((eq gender 'female)
                               ;; If female, sisters don't matter.
                               ;; Just check at least 1 allele from mother and father (if present)
                               (if (and father (alist-get father genobind))
                                   (atleastone? alleles father "father-daughter"))
                               (if (and mother (alist-get mother genobind))
                                   (atleastone? alleles mother "mother-daughter")))
                              ;;
                              (t (user-error "Unknown gender for %d" id))))))))))
      ;;
      ;; Remove duplicates (e.g. two brothers referencing each other)
      (let ((fixed nil))
        (cl-labels ((getrelationship (x) (car (plist-get x :relation)))
                    (getids (x) (-sort #'&lt; (cdr (plist-get x :relation))))
                    (elems-equal-p (first second)
                                   (and (string= (getrelationship first)
                                                 (getrelationship second))
                                        (equal (getids first)
                                               (getids second)))))
          (dolist (marker-err error-markers)
            (let* ((marker (car marker-err))
                   (data (cdr marker-err))
                   (indexes-reject nil))
              (dolist (relate-allele data)
                (let ((duplicates (--find-indices (elems-equal-p relate-allele it) data)))
                  (if (&gt; (length duplicates) 1)
                      (push (cadr duplicates) indexes-reject))))
              (if indexes-reject
                  (push (cons marker (-remove-at-indices
                                      (-uniq (-sort #'&lt; indexes-reject))
                                      data))
                        fixed)))))
        (mapconcat (lambda (it) (format "%s\t%s" (car it) (cdr it))) fixed "\n")))))
</pre>
</div>
</div>
</div>


<div id="outline-container-org3ef11f5" class="outline-5">
<h5 id="org3ef11f5">Test Genotypes</h5>
<div class="outline-text-5" id="text-org3ef11f5">
<p>
Below is a small subset of the genotypes file containing two markers we know are inconsistent, as well as two with <code>NC</code>'s which we will test on.
</p>

<div class="org-src-container">
<pre class="src src-text">Name	2020	2021	2022	2023	2024	2025	2026	2027	2028	2029	2030	2031	2032	2033	2034	2035	2036	2037	22	44	32	61	79	57	35	97
rs5983047	BB	AB	BB	AA	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	AB	BB	BB	BB	BB	AA	BB	BB
rs211641	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	AA	BB	BB	AB	AA	AB	BB	AA	BB	AA	AA
rs1000373	NC	NC	NC	NC	NC	NC	NC	NC	NC	NC	NC	NC	NC	NC	NC	NC	NC	NC	AB	AB	AB	AB	AB	AA	BB	AB
rs10001894	AA	AA	AA	AA	AA	AA	AA	AA	AA	AA	AA	AA	AA	AA	AA	AA	AA	AA	AA	NC	AA	AA	NC	AA	AA	AA
</pre>
</div>


<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">rs211641</td>
<td class="org-left">(:relation (father-son 2033 2035) :alleles (BB AA))</td>
<td class="org-left">(:relation (brother-brother 79 61) :alleles (AA BB))</td>
<td class="org-left">(:relation (brother-brother 61 79) :alleles (BB AA))</td>
<td class="org-left">(:relation (father-son 57 97) :alleles (BB AA))</td>
</tr>

<tr>
<td class="org-left">rs5983047</td>
<td class="org-left">(:relation (father-son 57 97) :alleles (AA BB))</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>

<p>
Good, it found both markers and with valid reasons, and the NC calls were ignored.
</p>
</div>
</div>

<div id="outline-container-org17483ea" class="outline-5">
<h5 id="org17483ea">Testing On Top 10</h5>
<div class="outline-text-5" id="text-org17483ea">
<p>
Before doing a full sweep of the genotypes let's just take the top 10 and see if we can deduplicate repetitive results (e.g. a brother-brother relation can be given two ways, 2035-2033 and 2033-2035).
</p>

<p>
The first test caught <code>NC</code> genotypes and misattributed a bad inheritance by trying to match it with actual genotype calls (see: rs10001894)
</p>

<table id="org7355f23" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">rs1000530</td>
<td class="org-left">(:relation (father-son 2029 2025) :alleles (AA BB))</td>
<td class="org-left">(:relation (brother-brother 2034 2033) :alleles (AA BB))</td>
<td class="org-left">(:relation (brother-brother 2033 2034) :alleles (BB AA))</td>
</tr>

<tr>
<td class="org-left">rs1000440</td>
<td class="org-left">(:relation (brother-brother 79 61) :alleles (BB AA))</td>
<td class="org-left">(:relation (brother-brother 61 79) :alleles (AA BB))</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">rs10002760</td>
<td class="org-left">(:relation (brother-brother 2034 2033) :alleles (BB AA))</td>
<td class="org-left">(:relation (brother-brother 2033 2034) :alleles (AA BB))</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">rs10002437</td>
<td class="org-left">(:relation (brother-brother 79 61) :alleles (BB NC))</td>
<td class="org-left">(:relation (brother-brother 61 79) :alleles (NC BB))</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">*rs10001894</td>
<td class="org-left">(:relation (brother-brother 79 61) :alleles (NC AA))</td>
<td class="org-left">(:relation (brother-brother 61 79) :alleles (AA NC))</td>
<td class="org-left">(:relation (father-daughter 44 35) :alleles (NC AA))</td>
</tr>

<tr>
<td class="org-left">rs1000141</td>
<td class="org-left">(:relation (mother-daughter 22 35) :alleles (NC AB))</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">rs1000121</td>
<td class="org-left">(:relation (brother-brother 79 61) :alleles (AA NC))</td>
<td class="org-left">(:relation (brother-brother 61 79) :alleles (NC AA))</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">rs10000988</td>
<td class="org-left">(:relation (mother-daughter 2030 2028) :alleles (NC BB))</td>
<td class="org-left">(:relation (mother-daughter 2037 2030) :alleles (BB NC))</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">rs10000984</td>
<td class="org-left">(:relation (brother-brother 2034 2033) :alleles (BB AA))</td>
<td class="org-left">(:relation (brother-brother 2033 2034) :alleles (AA BB))</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">rs1000047</td>
<td class="org-left">(:relation (brother-brother 79 61) :alleles (AA BB))</td>
<td class="org-left">(:relation (brother-brother 61 79) :alleles (BB AA))</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">rs10000438</td>
<td class="org-left">(:relation (brother-brother 79 61) :alleles (NC AB))</td>
<td class="org-left">(:relation (brother-brother 61 79) :alleles (AB NC))</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>

<p>
The second test bypassed the <code>NC</code> calls and produced only markers which were unambiguously incompatible (see: rs1000530 rs1000440 rs10002760). However it did produce duplicate  results on the same marker (see: rs10023523)
</p>

<table id="org03459ab" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">*rs10023523</td>
<td class="org-left">(:relation (brother-brother 2034 2033) :alleles (BB AA))</td>
<td class="org-left">(:relation (brother-brother 2033 2034) :alleles (AA BB))</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">rs1002182</td>
<td class="org-left">(:relation (brother-brother 2034 2033) :alleles (BB AA))</td>
<td class="org-left">(:relation (brother-brother 2033 2034) :alleles (AA BB))</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">rs10020676</td>
<td class="org-left">(:relation (brother-brother 2034 2033) :alleles (BB AA))</td>
<td class="org-left">(:relation (brother-brother 2033 2034) :alleles (AA BB))</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">rs10019140</td>
<td class="org-left">(:relation (brother-brother 2034 2033) :alleles (BB AA))</td>
<td class="org-left">(:relation (brother-brother 2033 2034) :alleles (AA BB))</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">rs1001874</td>
<td class="org-left">(:relation (father-son 2029 2025) :alleles (BB AA))</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">rs10006395</td>
<td class="org-left">(:relation (brother-brother 79 61) :alleles (BB AA))</td>
<td class="org-left">(:relation (brother-brother 61 79) :alleles (AA BB))</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">*rs1000530</td>
<td class="org-left">(:relation (father-son 2029 2025) :alleles (AA BB))</td>
<td class="org-left">(:relation (brother-brother 2034 2033) :alleles (AA BB))</td>
<td class="org-left">(:relation (brother-brother 2033 2034) :alleles (BB AA))</td>
</tr>

<tr>
<td class="org-left">*rs1000440</td>
<td class="org-left">(:relation (brother-brother 79 61) :alleles (BB AA))</td>
<td class="org-left">(:relation (brother-brother 61 79) :alleles (AA BB))</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">*rs10002760</td>
<td class="org-left">(:relation (brother-brother 2034 2033) :alleles (BB AA))</td>
<td class="org-left">(:relation (brother-brother 2033 2034) :alleles (AA BB))</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">rs10000984</td>
<td class="org-left">(:relation (brother-brother 2034 2033) :alleles (BB AA))</td>
<td class="org-left">(:relation (brother-brother 2033 2034) :alleles (AA BB))</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">rs1000047</td>
<td class="org-left">(:relation (brother-brother 79 61) :alleles (AA BB))</td>
<td class="org-left">(:relation (brother-brother 61 79) :alleles (BB AA))</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>

<p>
The third test removed the duplicates.
</p>

<table id="orgd8b6dc9" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">rs10023523</td>
<td class="org-left">(:relation (brother-brother 2034 2033) :alleles (BB AA))</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">rs1002182</td>
<td class="org-left">(:relation (brother-brother 2034 2033) :alleles (BB AA))</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">rs10020676</td>
<td class="org-left">(:relation (brother-brother 2034 2033) :alleles (BB AA))</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">rs10019140</td>
<td class="org-left">(:relation (brother-brother 2034 2033) :alleles (BB AA))</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">rs10006395</td>
<td class="org-left">(:relation (brother-brother 79 61) :alleles (BB AA))</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">rs1000530</td>
<td class="org-left">(:relation (father-son 2029 2025) :alleles (AA BB))</td>
<td class="org-left">(:relation (brother-brother 2034 2033) :alleles (AA BB))</td>
</tr>

<tr>
<td class="org-left">rs1000440</td>
<td class="org-left">(:relation (brother-brother 79 61) :alleles (BB AA))</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">rs10002760</td>
<td class="org-left">(:relation (brother-brother 2034 2033) :alleles (BB AA))</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">rs10000984</td>
<td class="org-left">(:relation (brother-brother 2034 2033) :alleles (BB AA))</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">rs1000047</td>
<td class="org-left">(:relation (brother-brother 79 61) :alleles (AA BB))</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org002ac88" class="outline-5">
<h5 id="org002ac88">Test on entire genotypes</h5>
<div class="outline-text-5" id="text-org002ac88">
<p>
Now we will parse the entire genotypes file (to file since this table became unspeakably long&#x2026;)
</p>

<p>
<a href="file:///home/tetris/work/linkage/second/inconsistent.txt">file:///home/tetris/work/linkage/second/inconsistent.txt</a>
</p>

<div class="org-src-container">
<pre class="src src-bash">head -10 ~/work/linkage/second/inconsistent.txt
wc -l ~/work/linkage/second/inconsistent.txt
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">rs1000047	((:relation (brother-brother 79 61) :alleles (AA BB)))</td>
</tr>

<tr>
<td class="org-left">rs10000984	((:relation (brother-brother 2034 2033) :alleles (BB AA)))</td>
</tr>

<tr>
<td class="org-left">rs10002760	((:relation (brother-brother 2034 2033) :alleles (BB AA)))</td>
</tr>

<tr>
<td class="org-left">rs1000440	((:relation (brother-brother 79 61) :alleles (BB AA)))</td>
</tr>

<tr>
<td class="org-left">rs1000530	((:relation (father-son 2029 2025) :alleles (AA BB)) (:relation (brother-brother 2034 2033) :alleles (AA BB)))</td>
</tr>

<tr>
<td class="org-left">rs10006395	((:relation (brother-brother 79 61) :alleles (BB AA)))</td>
</tr>

<tr>
<td class="org-left">rs10019140	((:relation (brother-brother 2034 2033) :alleles (BB AA)))</td>
</tr>

<tr>
<td class="org-left">rs10020676	((:relation (brother-brother 2034 2033) :alleles (BB AA)))</td>
</tr>

<tr>
<td class="org-left">rs1002182	((:relation (brother-brother 2034 2033) :alleles (BB AA)))</td>
</tr>

<tr>
<td class="org-left">rs10023523	((:relation (brother-brother 2034 2033) :alleles (BB AA)))</td>
</tr>

<tr>
<td class="org-left">8151 /home/tetris/work/linkage/second/inconsistent.txt</td>
</tr>
</tbody>
</table>

<p>
8000 inconsistent markers&#x2026;!
</p>
</div>

<ul class="org-ul">
<li><a id="org8d667fd"></a>Summarize inconsistent markers<br />
<div class="outline-text-6" id="text-org8d667fd">
<div class="org-src-container">
<pre class="src src-bash" id="org809a733">grep -oP ":relation \([^)]+\)"  $filename\
    | sed 's|:relation (||g'\
    | sort | uniq -c | sort -rnk 1
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">Occur</th>
<th scope="col" class="org-left">Relationship</th>
<th scope="col" class="org-right">ID1</th>
<th scope="col" class="org-right">ID2</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">4374</td>
<td class="org-left">brother-brother</td>
<td class="org-right">79</td>
<td class="org-right">61</td>
</tr>

<tr>
<td class="org-right">3933</td>
<td class="org-left">brother-brother</td>
<td class="org-right">2034</td>
<td class="org-right">2033</td>
</tr>

<tr>
<td class="org-right">504</td>
<td class="org-left">father-son</td>
<td class="org-right">2029</td>
<td class="org-right">2025</td>
</tr>

<tr>
<td class="org-right">496</td>
<td class="org-left">father-son</td>
<td class="org-right">2033</td>
<td class="org-right">2035</td>
</tr>

<tr>
<td class="org-right">489</td>
<td class="org-left">father-son</td>
<td class="org-right">2033</td>
<td class="org-right">2036</td>
</tr>

<tr>
<td class="org-right">426</td>
<td class="org-left">father-son</td>
<td class="org-right">57</td>
<td class="org-right">97</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-left">mother-daughter</td>
<td class="org-right">22</td>
<td class="org-right">35</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-left">mother-daughter</td>
<td class="org-right">2030</td>
<td class="org-right">2028</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-left">father-daughter</td>
<td class="org-right">44</td>
<td class="org-right">35</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-left">brother-brother</td>
<td class="org-right">2036</td>
<td class="org-right">2035</td>
</tr>
</tbody>
</table>

<p>
It appears that brothers 79 and 61 appear to have the most inconsistent markers, followed by 2034 and 2033. This raises a few alarming questions:
</p>

<ol class="org-ol">
<li>Why are so many markers inconsistent?</li>
<li>Why are most of the inconsistent markers to do with male-male relationships?</li>
</ol>

<p>
<b>Edit:</b> Oh. It turns out I was looking across the entire genotypes, but testing the male genotypes as if they were chromosome X only, giving a high amount of false positives because brothers do not need to share an allele when looking at autosomes&#x2026;.
</p>

<p>
Okay, let's rerun the above, this time looking only at chromosome X
</p>
</div>
</li>

<li><a id="orgab724da"></a>Parse the map<br />
<div class="outline-text-6" id="text-orgab724da">
<p>
We only wish to have the chromosome X markers, so let's build a quick map. We will use the complete map from <code>02_second/map.all.txt</code>.
</p>

<div class="org-src-container">
<pre class="src src-elisp">(setq chromX (make-hash-table :size 1000 :test #'equal))
(with-current-buffer (find-file-noselect "/ssh:tetris@132.230.153.85:/home/tetris/work/jobs_for_people/robert/118_canspanbrit/02_second/map.all.txt")
  (goto-char (point-min))
  (while (not (eobp))
    (let* ((lvals (split-string (buffer-substring-no-properties
                                 (point)
                                 (progn (forward-line 1) (point)))
                                "[	 ]" nil "[ \n]"))
           (chrom (string-trim (car lvals)))
           (marker (string-trim (cadr lvals))))
      (if (string= chrom "X")
          (puthash marker t chromX)))))
(hash-table-size chromX)
</pre>
</div>

<pre class="example">
5062
</pre>


<p>
5000 markers instead of 8000, better&#x2026;.
</p>
</div>
</li>
</ul>
</div>

<div id="outline-container-org819c0a3" class="outline-5">
<h5 id="org819c0a3">Test on Entire Genotypes (again, but this time on ChrX)</h5>
<div class="outline-text-5" id="text-org819c0a3">
<div class="org-src-container">
<pre class="src src-bash">head -10 ~/work/linkage/second/inconsistent.X.txt
wc -l ~/work/linkage/second/inconsistent.X.txt
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">rs1000530	((:relation (father-son 2029 2025) :alleles (AA BB)) (:relation (brother-brother 2034 2033) :alleles (AA BB)))</td>
</tr>

<tr>
<td class="org-left">rs1014724	((:relation (father-son 2033 2035) :alleles (BB AA)) (:relation (father-son 2033 2036) :alleles (BB AA)) (:relation (brother-brother 79 61) :alleles (AA BB)))</td>
</tr>

<tr>
<td class="org-left">rs1022525	((:relation (father-son 2033 2035) :alleles (BB AA)) (:relation (brother-brother 79 61) :alleles (AA BB)) (:relation (father-son 57 97) :alleles (AA BB)))</td>
</tr>

<tr>
<td class="org-left">rs1037524	((:relation (father-son 2029 2025) :alleles (AA BB)) (:relation (father-son 2033 2035) :alleles (AA BB)) (:relation (brother-brother 79 61) :alleles (AA BB)) (:relation (father-son 57 97) :alleles (AA BB)))</td>
</tr>

<tr>
<td class="org-left">rs10449065	((:relation (brother-brother 79 61) :alleles (BB AA)))</td>
</tr>

<tr>
<td class="org-left">rs10482174	((:relation (father-son 2029 2025) :alleles (BB AA)) (:relation (brother-brother 79 61) :alleles (BB AA)))</td>
</tr>

<tr>
<td class="org-left">rs10498674	((:relation (brother-brother 2034 2033) :alleles (BB AA)))</td>
</tr>

<tr>
<td class="org-left">rs10521415	((:relation (brother-brother 79 61) :alleles (BB AA)))</td>
</tr>

<tr>
<td class="org-left">rs10521417	((:relation (father-son 2029 2025) :alleles (BB AA)) (:relation (father-son 2033 2035) :alleles (AA BB)) (:relation (father-son 2033 2036) :alleles (AA BB)) (:relation (brother-brother 79 61) :alleles (BB AA)) (:relation (father-son 57 97) :alleles (AA BB)))</td>
</tr>

<tr>
<td class="org-left">rs10521418	((:relation (brother-brother 79 61) :alleles (BB AA)))</td>
</tr>

<tr>
<td class="org-left">671 /home/tetris/work/linkage/second/inconsistent.X.txt</td>
</tr>
</tbody>
</table>

<p>
Now it's only 671 inconsistent markers. That's a lot less than 8000, but still higher than I would have guessed.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">Occur</th>
<th scope="col" class="org-left">Relationship</th>
<th scope="col" class="org-right">ID1</th>
<th scope="col" class="org-right">ID2</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">508</td>
<td class="org-left">brother-brother</td>
<td class="org-right">79</td>
<td class="org-right">61</td>
</tr>

<tr>
<td class="org-right">295</td>
<td class="org-left">father-son</td>
<td class="org-right">2033</td>
<td class="org-right">2036</td>
</tr>

<tr>
<td class="org-right">295</td>
<td class="org-left">father-son</td>
<td class="org-right">2029</td>
<td class="org-right">2025</td>
</tr>

<tr>
<td class="org-right">289</td>
<td class="org-left">father-son</td>
<td class="org-right">2033</td>
<td class="org-right">2035</td>
</tr>

<tr>
<td class="org-right">265</td>
<td class="org-left">father-son</td>
<td class="org-right">57</td>
<td class="org-right">97</td>
</tr>

<tr>
<td class="org-right">184</td>
<td class="org-left">brother-brother</td>
<td class="org-right">2034</td>
<td class="org-right">2033</td>
</tr>
</tbody>
</table>

<p>
It appears that brothers 79 and 61 still appear to have more inconsistencies than others, but 2034 and 2033 are now on the lower end of the list. Also, there are no inconsistencies in female relationships, so I feel I can trust this result.
</p>

<p>
Just a quick look at the alleles too for these relationships
</p>

<div class="org-src-container">
<pre class="src src-bash">grep -oP ":relation \([^)]+\) :alleles \([^)]+\)" "/home/tetris/work/linkage/second/inconsistent.X.txt"\
    | sed -r 's/(:relation|:alleles)//g'\
    | sed -r 's/[\(\)]//g'\
    | sort | uniq -c
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">Occur</th>
<th scope="col" class="org-left">Relationship</th>
<th scope="col" class="org-right">ID1</th>
<th scope="col" class="org-right">ID2</th>
<th scope="col" class="org-left">A1</th>
<th scope="col" class="org-left">A2</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">100</td>
<td class="org-left">brother-brother</td>
<td class="org-right">2034</td>
<td class="org-right">2033</td>
<td class="org-left">AA</td>
<td class="org-left">BB</td>
</tr>

<tr>
<td class="org-right">84</td>
<td class="org-left">brother-brother</td>
<td class="org-right">2034</td>
<td class="org-right">2033</td>
<td class="org-left">BB</td>
<td class="org-left">AA</td>
</tr>

<tr>
<td class="org-right">251</td>
<td class="org-left">brother-brother</td>
<td class="org-right">79</td>
<td class="org-right">61</td>
<td class="org-left">AA</td>
<td class="org-left">BB</td>
</tr>

<tr>
<td class="org-right">257</td>
<td class="org-left">brother-brother</td>
<td class="org-right">79</td>
<td class="org-right">61</td>
<td class="org-left">BB</td>
<td class="org-left">AA</td>
</tr>

<tr>
<td class="org-right">145</td>
<td class="org-left">father-son</td>
<td class="org-right">2029</td>
<td class="org-right">2025</td>
<td class="org-left">AA</td>
<td class="org-left">BB</td>
</tr>

<tr>
<td class="org-right">150</td>
<td class="org-left">father-son</td>
<td class="org-right">2029</td>
<td class="org-right">2025</td>
<td class="org-left">BB</td>
<td class="org-left">AA</td>
</tr>

<tr>
<td class="org-right">145</td>
<td class="org-left">father-son</td>
<td class="org-right">2033</td>
<td class="org-right">2035</td>
<td class="org-left">AA</td>
<td class="org-left">BB</td>
</tr>

<tr>
<td class="org-right">144</td>
<td class="org-left">father-son</td>
<td class="org-right">2033</td>
<td class="org-right">2035</td>
<td class="org-left">BB</td>
<td class="org-left">AA</td>
</tr>

<tr>
<td class="org-right">145</td>
<td class="org-left">father-son</td>
<td class="org-right">2033</td>
<td class="org-right">2036</td>
<td class="org-left">AA</td>
<td class="org-left">BB</td>
</tr>

<tr>
<td class="org-right">150</td>
<td class="org-left">father-son</td>
<td class="org-right">2033</td>
<td class="org-right">2036</td>
<td class="org-left">BB</td>
<td class="org-left">AA</td>
</tr>

<tr>
<td class="org-right">140</td>
<td class="org-left">father-son</td>
<td class="org-right">57</td>
<td class="org-right">97</td>
<td class="org-left">AA</td>
<td class="org-left">BB</td>
</tr>

<tr>
<td class="org-right">125</td>
<td class="org-left">father-son</td>
<td class="org-right">57</td>
<td class="org-right">97</td>
<td class="org-left">BB</td>
<td class="org-left">AA</td>
</tr>
</tbody>
</table>

<p>
Yep, not a common Y allele from father to son, and brother to brother.
</p>
</div>
</div>
</div>


<div id="outline-container-org427e41f" class="outline-3">
<h3 id="org427e41f">Remove inconsistent X-linked Markers from genotypes</h3>
<div class="outline-text-3" id="text-org427e41f">
<p>
Write out a new genotypes and maf file.
</p>

<div class="org-src-container">
<pre class="src src-elisp" id="org12731d5">(cl-labels ((readline () (buffer-substring-no-properties (point) (progn (forward-line 1) (point))))
            (readtokens (line) (split-string line "[	 ]" nil "[ \n]"))
            (processfile (oldbuff newbuff) (with-current-buffer oldbuff
                                             (goto-char (point-min))
                                             (while (not (eobp))
                                               (let* ((line (readline))
                                                      (marker (string-trim (car (readtokens line)))))
                                                 (unless (member marker unwanted)
                                                   (with-current-buffer newbuff
                                                     (insert line))))))))
  (let ((unwanted nil)
        (oldgenos (find-file-noselect (concat olddir "/genotypes")))
        (newgenos (find-file-noselect (concat newdir "/genotypes")))
        (oldmaf (find-file-noselect (concat olddir "/maf.txt")))
        (newmaf (find-file-noselect (concat newdir "/maf.txt"))))
    ;; Read unwanted markers
    (with-current-buffer (find-file-noselect inconsis)
      (goto-char (point-min))
      (while (not (eobp)) (push (string-trim (car (readtokens (readline)))) unwanted)))
    ;; Genotypes
    (processfile oldgenos newgenos)
    ;; MAF
    (processfile oldmaf newmaf)))
</pre>
</div>

<p>
Let's see how much was removed:
</p>

<div class="org-src-container">
<pre class="src src-bash">wc -l genotypes maf.txt
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">Lines</th>
<th scope="col" class="org-left">File</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">214093</td>
<td class="org-left">genotypes</td>
</tr>

<tr>
<td class="org-right">214093</td>
<td class="org-left">maf.txt</td>
</tr>
</tbody>
</table>


<div class="org-src-container">
<pre class="src src-bash">wc -l genotypes maf.txt
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">Lines</th>
<th scope="col" class="org-left">File</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">213421</td>
<td class="org-left">genotypes</td>
</tr>

<tr>
<td class="org-right">213421</td>
<td class="org-left">maf.txt</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-elisp">(cons (cons "genotypes" (- 214093 213421))
      (cons "maf.txt" (- 214093 213421)))
</pre>
</div>

<pre class="example">
((genotypes . 672) maf.txt . 672)
</pre>


<p>
672 chrX markers removed in the new files (671 markers + 1 newline at the end of the file which I clip out of habit).
</p>

<p>
Okay, let's re-run snpbutcher again and try for another analysis
</p>
</div>
</div>
</div>


<div id="outline-container-org7e0d2f3" class="outline-2">
<h2 id="org7e0d2f3">Linkage Analysis (Attempt 4)</h2>
<div class="outline-text-2" id="text-org7e0d2f3">
</div>
<div id="outline-container-orgd9543fe" class="outline-3">
<h3 id="orgd9543fe">Snpbutcher</h3>
<div class="outline-text-3" id="text-orgd9543fe">
<p>
First let's copy over the maf and genotypes to the <code>third</code> directory to the work machine (here will use dired). We copy the pedfile from the <code>03_analysis</code> folder and the <code>map.all.txt</code> file from the <code>02_analysis</code> folder.
</p>

<div class="org-src-container">
<pre class="src src-sh">wc -l *
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">Lines</th>
<th scope="col" class="org-left">Files</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">213421</td>
<td class="org-left">genotypes</td>
</tr>

<tr>
<td class="org-right">213421</td>
<td class="org-left">maf.txt</td>
</tr>

<tr>
<td class="org-right">116171</td>
<td class="org-left">map.all.txt</td>
</tr>

<tr>
<td class="org-right">37</td>
<td class="org-left">pedfile.pro</td>
</tr>
</tbody>
</table>


<div class="org-src-container">
<pre class="src src-sh">snpbutcher2.py map.all.txt maf.txt genotypes -z -nh &gt; map.txt
</pre>
</div>

<pre class="example">
[ARGS] Zero maf markers too, NOT using hapmap

[INFO] reading 'genotypes'...
[INFO] found 15607/213421 SNPs uninformative
[INFO] reading 'map.all.txt' and printing new map...
[INFO] chromosome 01 02 03 04 05 06 07 08 09 10 11 12 13 14 15 16 17 18 19 20 21 22 X
[INFO] new map contains 37762 SNPs
</pre>


<p>
37,672 markers
</p>

<div class="org-src-container">
<pre class="src src-sh">awk '{print $1}' map.txt | sort | uniq -c
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">Makers</th>
<th scope="col" class="org-right">Chrom</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">2802</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-right">2858</td>
<td class="org-right">2</td>
</tr>

<tr>
<td class="org-right">2419</td>
<td class="org-right">3</td>
</tr>

<tr>
<td class="org-right">2260</td>
<td class="org-right">4</td>
</tr>

<tr>
<td class="org-right">2315</td>
<td class="org-right">5</td>
</tr>

<tr>
<td class="org-right">2146</td>
<td class="org-right">6</td>
</tr>

<tr>
<td class="org-right">2030</td>
<td class="org-right">7</td>
</tr>

<tr>
<td class="org-right">1871</td>
<td class="org-right">8</td>
</tr>

<tr>
<td class="org-right">1672</td>
<td class="org-right">9</td>
</tr>

<tr>
<td class="org-right">1847</td>
<td class="org-right">10</td>
</tr>

<tr>
<td class="org-right">1692</td>
<td class="org-right">11</td>
</tr>

<tr>
<td class="org-right">1772</td>
<td class="org-right">12</td>
</tr>

<tr>
<td class="org-right">1361</td>
<td class="org-right">13</td>
</tr>

<tr>
<td class="org-right">1225</td>
<td class="org-right">14</td>
</tr>

<tr>
<td class="org-right">1238</td>
<td class="org-right">15</td>
</tr>

<tr>
<td class="org-right">1292</td>
<td class="org-right">16</td>
</tr>

<tr>
<td class="org-right">1252</td>
<td class="org-right">17</td>
</tr>

<tr>
<td class="org-right">1231</td>
<td class="org-right">18</td>
</tr>

<tr>
<td class="org-right">870</td>
<td class="org-right">19</td>
</tr>

<tr>
<td class="org-right">1133</td>
<td class="org-right">20</td>
</tr>

<tr>
<td class="org-right">720</td>
<td class="org-right">21</td>
</tr>

<tr>
<td class="org-right">655</td>
<td class="org-right">22</td>
</tr>

<tr>
<td class="org-right">1101</td>
<td class="org-right">X</td>
</tr>
</tbody>
</table>

<p>
1100 markers from chrom X. Hopefully, all consistent.
</p>
</div>
</div>

<div id="outline-container-orged25402" class="outline-3">
<h3 id="orged25402">Run 4: Fingers crossed</h3>
<div class="outline-text-3" id="text-orged25402">
<p>
Nope, fails at chrX again, this time with <code>rs5983020</code> being the inconsistent marker for family 1181.
</p>

<p>
Let's have a look.
</p>

<div class="org-src-container">
<pre class="src src-sh">cut -f 1,20-27 /mnt/robert/118_canspanbrit/04_noinconsistentx/genotypes | head -1
cut -f 1,20-27 /mnt/robert/118_canspanbrit/04_noinconsistentx/genotypes | grep rs5983020
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<tbody>
<tr>
<td class="org-left">Name</td>
<td class="org-right">22</td>
<td class="org-right">44</td>
<td class="org-right">32</td>
<td class="org-right">61</td>
<td class="org-right">79</td>
<td class="org-right">57</td>
<td class="org-right">35</td>
<td class="org-right">97</td>
</tr>

<tr>
<td class="org-left">rs5983020</td>
<td class="org-right">AB</td>
<td class="org-right">BB</td>
<td class="org-right">BB</td>
<td class="org-right">BB</td>
<td class="org-right">BB</td>
<td class="org-right">AA</td>
<td class="org-right">BB</td>
<td class="org-right">BB</td>
</tr>
</tbody>
</table>

<p>
Males on left, females on right
</p>

<div class="org-src-container">
<pre class="src src-artist">             7623[XY] --- 7624[XX]
                       |
              _________|_____________
             |                       |
7620[XY] --- 32[BB]      44[BB] --- 22[AB]
          |                      |
      ____|___                   |
     |        |      57[AA] --- 35[BB]
 *79[BB]    *61[BB]           |
                           *97[BB]
</pre>
</div>

<p>
It looks like we have an illegal inheritance between father-son 57-97.
</p>

<p>
How did I miss this?
</p>
</div>

<div id="outline-container-org988547b" class="outline-4">
<h4 id="org988547b">Debugging the methods again</h4>
<div class="outline-text-4" id="text-org988547b">
<p>
Let's add our new marker to our test genotypes
</p>

<div class="org-src-container">
<pre class="src src-sh">cat /mnt/robert/118_canspanbrit/04_noinconsistentx/genotypes | grep rs5983020
</pre>
</div>

<pre class="example">
rs5983020	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	AB	BB	BB	BB	BB	AA	BB	BB
</pre>



<div class="org-src-container">
<pre class="src src-text">Name	2020	2021	2022	2023	2024	2025	2026	2027	2028	2029	2030	2031	2032	2033	2034	2035	2036	2037	22	44	32	61	79	57	35	97
rs5983020	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	AB	BB	BB	BB	BB	AA	BB	BB
rs5983047	BB	AB	BB	AA	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	AB	BB	BB	BB	BB	AA	BB	BB
rs211641	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	AA	BB	BB	AB	AA	AB	BB	AA	BB	AA	AA
rs1000373	NC	NC	NC	NC	NC	NC	NC	NC	NC	NC	NC	NC	NC	NC	NC	NC	NC	NC	AB	AB	AB	AB	AB	AA	BB	AB
rs10001894	AA	AA	AA	AA	AA	AA	AA	AA	AA	AA	AA	AA	AA	AA	AA	AA	AA	AA	AA	NC	AA	AA	NC	AA	AA	AA
</pre>
</div>

<p>
and now test (need to rerun both pedigree functions fist, and the populate chromX from the map, and then run this)
</p>

<pre class="example">
rs211641	((:relation (father-son 2033 2035) :alleles (BB AA)) (:relation (brother-brother 79 61) :alleles (AA BB)) (:relation (father-son 57 97) :alleles (BB AA)))
</pre>


<p>
It only finds the one marker, and skips <code>rs5983020</code>&#x2026; let's step through&#x2026;
</p>
</div>

<div id="outline-container-orgdb9a6d3" class="outline-5">
<h5 id="orgdb9a6d3">Methods</h5>
<div class="outline-text-5" id="text-orgdb9a6d3">
<div class="org-src-container">
<pre class="src src-elisp" id="orgc939c72">(cl-labels ((readtokens () (split-string (buffer-substring-no-properties
                                          (point)
                                          (progn (forward-line 1) (point)))
                                         "[	 ]" nil "[ \n]"))
            (unitealleles (allpairs) (format "%s%s" (car allpairs) (cadr allpairs)))
            (atleastone? (alleles parentid relationship)
                         (--&gt; (alist-get parentid genobind)
                              (unless (or (member (car alleles) it)
                                          (member (cadr alleles) it))
                                ;; 1 allele not inherited
                                (let ((newinf (list :relation (list relationship parentid id)
                                                    :alleles (list (unitealleles it) (unitealleles alleles))))
                                      (existing (alist-get marker error-markers nil nil #'equal)))
                                  (if existing
                                      (setf (alist-get marker error-markers nil nil #'equal)
                                            (append existing (list newinf)))
                                    ;; Otherwise push new
                                    (push (list marker newinf) error-markers)))))))
  (with-current-buffer (find-file-noselect filename)
    (goto-char (point-min))
    (let ((headers (-map #'string-to-number (cdr (readtokens))))
          (error-markers nil))
      (while (not (eobp))
      ;;(while (&lt;= (length error-markers) 10)
        (let* ((linedata (readtokens))
               (marker (car linedata))
               (genobind nil))
          (if (gethash marker chromX)
              ;; convert genotypes from strings to symbols ("AB" to (A . B))
              (let* ((genotypes (--map (if it (list (intern (car it)) (intern (cadr it))))
                                       (--map (if (string= "NC" it) nil
                                                (split-string it "" t))
                                              (cdr linedata))))
                     ;; Each line will be bound to the header (e.g. 2020 . AA, 2022 . BB)
                     (genobind (--zip-with (cons it other) headers genotypes)))
                ;; Now we iterate through the individuals
                (dolist (indiv genobind)
                  (let* ((id (car indiv))
                         (alleles (cdr indiv))
                         ;; pedigree info
                         (indiv-info (alist-get id pedigree))
                         (gender (plist-get indiv-info :gender))
                         (mother (plist-get indiv-info :mother))
                         (father (plist-get indiv-info :father))
                         (sisters (plist-get indiv-info :sisters))
                         (brothers (plist-get indiv-info :brothers)))
                    ;;
                    (if alleles  ;; NC we ignore
                        (cond ((eq gender 'male)
                               ;; If male, check brothers and fathers
                               (if (and father (alist-get father genobind))
                                   ;; At this point we could check all brothers against their father's types
                                   ;; too, but note that we will effectively do this in later iterations
                                   ;; when the individual becomes one of the brothers.
                                   (atleastone? alleles father "father-son")
                                 ;;
                                 ;; If no father, check against brothers
                                 (dolist (bro brothers)
                                   (if (alist-get bro genobind)  ;; NC we ignore
                                       (atleastone? alleles bro "brother-brother")))))
                              ;;
                              ((eq gender 'female)
                               ;; If female, sisters don't matter.
                               ;; Just check at least 1 allele from mother and father (if present)
                               (if (and father (alist-get father genobind))
                                   (atleastone? alleles father "father-daughter"))
                               (if (and mother (alist-get mother genobind))
                                   (atleastone? alleles mother "mother-daughter")))
                              ;;
                              (t (user-error "Unknown gender for %d" id))))))))))
      ;;
      ;; Remove duplicates (e.g. two brothers referencing each other)
      (let ((fixed nil))
        (cl-labels ((getrelationship (x) (car (plist-get x :relation)))
                    (getids (x) (-sort #'&lt; (cdr (plist-get x :relation))))
                    (elems-equal-p (first second)
                                   (and (string= (getrelationship first)
                                                 (getrelationship second))
                                        (equal (getids first)
                                               (getids second)))))
          (dolist (marker-err error-markers)
            (let* ((marker (car marker-err))
                   (data (cdr marker-err))
                   (indexes-reject nil))
              (dolist (relate-allele data)
                (let ((duplicates (--find-indices (elems-equal-p relate-allele it) data)))
                  (if (&gt; (length duplicates) 1)
                      (push (cadr duplicates) indexes-reject))))
              (if indexes-reject
                  (push (cons marker (-remove-at-indices
                                      (-uniq (-sort #'&lt; indexes-reject))
                                      data))
                        fixed)
                ;; if no duplicates add to fixed &lt;-- problem was here
                (push (cons marker data) fixed)))))
        (setq outfixed fixed)
        (mapconcat (lambda (it) (format "%s\t%s" (car it) (cdr it))) fixed "\n")))))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-elisp" id="org3b24f30">(with-current-buffer (find-file-noselect outname)
  (insert "Marker\tRelationship\tID1\tID2\tAllele1\tAllele2\n")
  (dolist (line outfixed)
    (let ((marker (car line))
          (relatedata (cdr line)))
      (dolist (fac relatedata)
        (let ((relate (car (plist-get fac :relation)))
              (id1 (cadr (plist-get fac :relation)))
              (id2 (caddr (plist-get fac :relation)))
              (al1 (car (plist-get fac :alleles)))
              (al2 (cadr (plist-get fac :alleles))))
          (insert (format "%s\t%s\t%d\t%d\t%s\t%s\n"
                          marker relate id1 id2 al1 al2)))))))
  ;;(save-buffer))
</pre>
</div>

<p>
Found it. The de-duplicate function only output markers with duplicate info and skipped the ones which were already unique. Now fixed.
</p>

<p>
If we run the updated code on our test file, we should see much more:
</p>

<div class="org-src-container">
<pre class="src src-text">Name	2020	2021	2022	2023	2024	2025	2026	2027	2028	2029	2030	2031	2032	2033	2034	2035	2036	2037	22	44	32	61	79	57	35	97
rs5983020	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	AB	BB	BB	BB	BB	AA	BB	BB
rs5983047	BB	AB	BB	AA	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	AB	BB	BB	BB	BB	AA	BB	BB
rs211641	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	BB	AA	BB	BB	AB	AA	AB	BB	AA	BB	AA	AA
rs1000373	NC	NC	NC	NC	NC	NC	NC	NC	NC	NC	NC	NC	NC	NC	NC	NC	NC	NC	AB	AB	AB	AB	AB	AA	BB	AB
rs10001894	AA	AA	AA	AA	AA	AA	AA	AA	AA	AA	AA	AA	AA	AA	AA	AA	AA	AA	AA	NC	AA	AA	NC	AA	AA	AA
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">rs5983020</td>
<td class="org-left">(:relation (father-son 57 97) :alleles (AA BB))</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">rs5983047</td>
<td class="org-left">(:relation (father-son 57 97) :alleles (AA BB))</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">rs211641</td>
<td class="org-left">(:relation (father-son 2033 2035) :alleles (BB AA))</td>
<td class="org-left">(:relation (brother-brother 79 61) :alleles (AA BB))</td>
<td class="org-left">(:relation (father-son 57 97) :alleles (BB AA))</td>
</tr>
</tbody>
</table>

<p>
So now it correctly outputs markers with unique relations
</p>
</div>
</div>
</div>


<div id="outline-container-orgd4c6c4a" class="outline-4">
<h4 id="orgd4c6c4a">Finding inconsistent X markers (updated)</h4>
<div class="outline-text-4" id="text-orgd4c6c4a">
<p>
We will generated from the same genotypes file as before
</p>

<div class="org-src-container">
<pre class="src src-bash">head -10 ~/work/linkage/third/inconsistent2.X.txt
wc -l ~/work/linkage/third/inconsistent2.X.txt
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">rs1000530	((:relation (father-son 2029 2025) :alleles (AA BB)) (:relation (brother-brother 2034 2033) :alleles (AA BB)))</td>
</tr>

<tr>
<td class="org-left">rs1004916	((:relation (father-son 57 97) :alleles (AA BB)))</td>
</tr>

<tr>
<td class="org-left">rs1005295	((:relation (father-son 2029 2025) :alleles (BB AA)))</td>
</tr>

<tr>
<td class="org-left">rs1005612	((:relation (father-son 57 97) :alleles (AA BB)))</td>
</tr>

<tr>
<td class="org-left">rs1006282	((:relation (father-son 2029 2025) :alleles (AA BB)))</td>
</tr>

<tr>
<td class="org-left">rs1007744	((:relation (father-son 2033 2035) :alleles (AA BB)) (:relation (father-son 2033 2036) :alleles (AA BB)) (:relation (father-son 57 97) :alleles (BB AA)))</td>
</tr>

<tr>
<td class="org-left">rs10081894	((:relation (father-son 2033 2035) :alleles (AA BB)) (:relation (father-son 2033 2036) :alleles (AA BB)))</td>
</tr>

<tr>
<td class="org-left">rs1010041	((:relation (father-son 2029 2025) :alleles (BB AA)))</td>
</tr>

<tr>
<td class="org-left">rs1010796	((:relation (father-son 2029 2025) :alleles (BB AA)))</td>
</tr>

<tr>
<td class="org-left">rs1012224	((:relation (father-son 2033 2036) :alleles (AA BB)) (:relation (father-son 57 97) :alleles (BB AA)))</td>
</tr>

<tr>
<td class="org-left">2555 /home/tetris/work/linkage/third/inconsistent2.X.txt</td>
</tr>
</tbody>
</table>

<p>
From 671 inconsistent markers, it's 2555&#x2026; that's still a lot less than 8000, but still far far higher than I would have guessed. It sounds like one individual is messing up the linkage. I would guess it's the 57 to 96 relation. Let's see&#x2026;
</p>

<table id="org8706e84" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 1:</span> Markers Removed By Relation</caption>

<colgroup>
<col  class="org-right" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">Occur</th>
<th scope="col" class="org-left">Relationship</th>
<th scope="col" class="org-right">ID1</th>
<th scope="col" class="org-right">ID2</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">1227</td>
<td class="org-left">father-son</td>
<td class="org-right">2029</td>
<td class="org-right">2025</td>
</tr>

<tr>
<td class="org-right">1200</td>
<td class="org-left">father-son</td>
<td class="org-right">2033</td>
<td class="org-right">2036</td>
</tr>

<tr>
<td class="org-right">1184</td>
<td class="org-left">father-son</td>
<td class="org-right">2033</td>
<td class="org-right">2035</td>
</tr>

<tr>
<td class="org-right">1155</td>
<td class="org-left">father-son</td>
<td class="org-right">57</td>
<td class="org-right">97</td>
</tr>

<tr>
<td class="org-right">508</td>
<td class="org-left">brother-brother</td>
<td class="org-right">79</td>
<td class="org-right">61</td>
</tr>

<tr>
<td class="org-right">184</td>
<td class="org-left">brother-brother</td>
<td class="org-right">2034</td>
<td class="org-right">2033</td>
</tr>
</tbody>
</table>

<p>
No, not necessarily - plenty of other inconsistent father-son markers.
</p>

<p>
If we compare that to our previous:
</p>

<table id="orgb9b5760" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 2:</span> Previous Table</caption>

<colgroup>
<col  class="org-right" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">Occur</th>
<th scope="col" class="org-left">Relationship</th>
<th scope="col" class="org-right">ID1</th>
<th scope="col" class="org-right">ID2</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">508</td>
<td class="org-left">brother-brother</td>
<td class="org-right">79</td>
<td class="org-right">61</td>
</tr>

<tr>
<td class="org-right">295</td>
<td class="org-left">father-son</td>
<td class="org-right">2033</td>
<td class="org-right">2036</td>
</tr>

<tr>
<td class="org-right">295</td>
<td class="org-left">father-son</td>
<td class="org-right">2029</td>
<td class="org-right">2025</td>
</tr>

<tr>
<td class="org-right">289</td>
<td class="org-left">father-son</td>
<td class="org-right">2033</td>
<td class="org-right">2035</td>
</tr>

<tr>
<td class="org-right">265</td>
<td class="org-left">father-son</td>
<td class="org-right">57</td>
<td class="org-right">97</td>
</tr>

<tr>
<td class="org-right">184</td>
<td class="org-left">brother-brother</td>
<td class="org-right">2034</td>
<td class="org-right">2033</td>
</tr>
</tbody>
</table>

<p>
We see that the <code>brother-brother</code> numbers have not increased which is expected since brothers referencing each other will no doubt produce duplicates.
</p>
</div>
</div>

<div id="outline-container-orge60fe1f" class="outline-4">
<h4 id="orge60fe1f">Filtering out inconsistent markers</h4>
<div class="outline-text-4" id="text-orge60fe1f">
<div class="org-src-container">
<pre class="src src-bash">mkdir -p /home/tetris/work/linkage/fourth
</pre>
</div>

<p>
Let's see what changed
</p>

<div class="org-src-container">
<pre class="src src-bash">wc -l genotypes maf.txt
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">Lines</th>
<th scope="col" class="org-left">File</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">214093</td>
<td class="org-left">genotypes</td>
</tr>

<tr>
<td class="org-right">214093</td>
<td class="org-left">maf.txt</td>
</tr>
</tbody>
</table>


<div class="org-src-container">
<pre class="src src-bash">wc -l genotypes maf.txt
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">Lines</th>
<th scope="col" class="org-left">File</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">211537</td>
<td class="org-left">genotypes</td>
</tr>

<tr>
<td class="org-right">211537</td>
<td class="org-left">maf.txt</td>
</tr>
</tbody>
</table>


<div class="org-src-container">
<pre class="src src-elisp">(cons (cons "genotypes" (- 214093 211537))
      (cons "maf.txt" (- 214093 211537)))
</pre>
</div>

<pre class="example">
((genotypes . 2556) maf.txt . 2556)
</pre>


<p>
2555 markers removed (+1 newline).
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org827fd0b" class="outline-2">
<h2 id="org827fd0b">Linkage Analysis (Attempt 5)</h2>
<div class="outline-text-2" id="text-org827fd0b">
</div>
<div id="outline-container-org8d40323" class="outline-3">
<h3 id="org8d40323">Snpbutcher</h3>
<div class="outline-text-3" id="text-org8d40323">
<p>
   Again we copy over the maf and genotypes, this time from <code>fourth</code> directory to the work machine. We copy the pedfile from the <code>04_analysis</code>
folder and the <code>map.all.txt</code> file from the <code>02_analysis</code> folder.
</p>

<div class="org-src-container">
<pre class="src src-sh">wc -l *
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-right">211537</td>
<td class="org-left">genotypes</td>
</tr>

<tr>
<td class="org-right">211537</td>
<td class="org-left">maf.txt</td>
</tr>

<tr>
<td class="org-right">116171</td>
<td class="org-left">map.all.txt</td>
</tr>

<tr>
<td class="org-right">37</td>
<td class="org-left">pedfile.pro</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-sh">snpbutcher2.py map.all.txt maf.txt genotypes -z -nh &gt; map.txt
awk '{print $1}' map.txt | sort | uniq -c | grep X
</pre>
</div>

<pre class="example">
[ARGS] Zero maf markers too, NOT using hapmap

[INFO] reading 'genotypes'...
[INFO] found 15607/211537 SNPs uninformative
[INFO] reading 'map.all.txt' and printing new map...
[INFO] chromosome 01 02 03 04 05 06 07 08 09 10 11 12 13 14 15 16 17 18 19 20 21 22 X
[INFO] new map contains 36974 SNPs
$     313 X
</pre>


<p>
36,974 markers, of which only 313 consistent markers are X-linked&#x2026;
Let's see how many markers we actually have if we increase the resolution.
</p>

<div class="org-src-container">
<pre class="src src-sh">snpbutcher2.py map.all.txt maf.txt genotypes -z -nh -cm 0 &gt; mapFull.txt
awk '{print $1}' mapFull.txt | sort | uniq -c | grep X
</pre>
</div>

<pre class="example">
[ARGS] cM: 0.000000, Zero maf markers too, NOT using hapmap

[INFO] reading 'genotypes'...
[INFO] found 15607/211537 SNPs uninformative
[INFO] reading 'map.all.txt' and printing new map...
[INFO] chromosome 01 02 03 04 05 06 07 08 09 10 11 12 13 14 15 16 17 18 19 20 21 22 X
[INFO] new map contains 101023 SNPs
$     412 X
</pre>


<p>
412 informative X-linked markers&#x2026; this is twice as low as we would expect, but who knows maybe we can do some linkage on that.
Let's do a quick check to see if our previously unwanted markers are in there.
</p>

<div class="org-src-container">
<pre class="src src-sh">cat mapFull.txt | grep -P "(rs1000530|rs1004916|rs1005295|rs1005612|rs1006282|rs1007744|rs10081894|rs1010041|rs1010796|rs1012224)\s"
</pre>
</div>

<p>
Empty, good.
</p>
</div>

<div id="outline-container-orgc685cbd" class="outline-4">
<h4 id="orgc685cbd">Concatenate small map with full res X map</h4>
<div class="outline-text-4" id="text-orgc685cbd">
<p>
So we wish to keep the full 412 chrX markers and put them into the standard snpbutcher map.
</p>

<div class="org-src-container">
<pre class="src src-sh">awk '{print $1}' map.txt | sort | uniq -c
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<tbody>
<tr>
<td class="org-right">2802</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-right">2858</td>
<td class="org-right">2</td>
</tr>

<tr>
<td class="org-right">2419</td>
<td class="org-right">3</td>
</tr>

<tr>
<td class="org-right">2260</td>
<td class="org-right">4</td>
</tr>

<tr>
<td class="org-right">2315</td>
<td class="org-right">5</td>
</tr>

<tr>
<td class="org-right">2146</td>
<td class="org-right">6</td>
</tr>

<tr>
<td class="org-right">2030</td>
<td class="org-right">7</td>
</tr>

<tr>
<td class="org-right">1871</td>
<td class="org-right">8</td>
</tr>

<tr>
<td class="org-right">1672</td>
<td class="org-right">9</td>
</tr>

<tr>
<td class="org-right">1847</td>
<td class="org-right">10</td>
</tr>

<tr>
<td class="org-right">1692</td>
<td class="org-right">11</td>
</tr>

<tr>
<td class="org-right">1772</td>
<td class="org-right">12</td>
</tr>

<tr>
<td class="org-right">1361</td>
<td class="org-right">13</td>
</tr>

<tr>
<td class="org-right">1225</td>
<td class="org-right">14</td>
</tr>

<tr>
<td class="org-right">1238</td>
<td class="org-right">15</td>
</tr>

<tr>
<td class="org-right">1292</td>
<td class="org-right">16</td>
</tr>

<tr>
<td class="org-right">1252</td>
<td class="org-right">17</td>
</tr>

<tr>
<td class="org-right">1231</td>
<td class="org-right">18</td>
</tr>

<tr>
<td class="org-right">870</td>
<td class="org-right">19</td>
</tr>

<tr>
<td class="org-right">1133</td>
<td class="org-right">20</td>
</tr>

<tr>
<td class="org-right">720</td>
<td class="org-right">21</td>
</tr>

<tr>
<td class="org-right">655</td>
<td class="org-right">22</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-right">Chr</td>
</tr>

<tr>
<td class="org-right">313</td>
<td class="org-right">X</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-sh">cat map.txt | grep -v "^X" &gt; only.autosomes.half
cat mapFull.txt | grep "^X" &gt; only.X.full
cat only.autosomes.half only.X.full &gt; map.new.txt
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">mv map.txt mapHalf.txt
mv map.new.txt map.txt
</pre>
</div>

<p>
Quick summary of current map file
</p>

<div class="org-src-container">
<pre class="src src-sh">awk '{print $1}' map.txt | sort | uniq -c
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<tbody>
<tr>
<td class="org-right">2802</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-right">2858</td>
<td class="org-right">2</td>
</tr>

<tr>
<td class="org-right">2419</td>
<td class="org-right">3</td>
</tr>

<tr>
<td class="org-right">2260</td>
<td class="org-right">4</td>
</tr>

<tr>
<td class="org-right">2315</td>
<td class="org-right">5</td>
</tr>

<tr>
<td class="org-right">2146</td>
<td class="org-right">6</td>
</tr>

<tr>
<td class="org-right">2030</td>
<td class="org-right">7</td>
</tr>

<tr>
<td class="org-right">1871</td>
<td class="org-right">8</td>
</tr>

<tr>
<td class="org-right">1672</td>
<td class="org-right">9</td>
</tr>

<tr>
<td class="org-right">1847</td>
<td class="org-right">10</td>
</tr>

<tr>
<td class="org-right">1692</td>
<td class="org-right">11</td>
</tr>

<tr>
<td class="org-right">1772</td>
<td class="org-right">12</td>
</tr>

<tr>
<td class="org-right">1361</td>
<td class="org-right">13</td>
</tr>

<tr>
<td class="org-right">1225</td>
<td class="org-right">14</td>
</tr>

<tr>
<td class="org-right">1238</td>
<td class="org-right">15</td>
</tr>

<tr>
<td class="org-right">1292</td>
<td class="org-right">16</td>
</tr>

<tr>
<td class="org-right">1252</td>
<td class="org-right">17</td>
</tr>

<tr>
<td class="org-right">1231</td>
<td class="org-right">18</td>
</tr>

<tr>
<td class="org-right">870</td>
<td class="org-right">19</td>
</tr>

<tr>
<td class="org-right">1133</td>
<td class="org-right">20</td>
</tr>

<tr>
<td class="org-right">720</td>
<td class="org-right">21</td>
</tr>

<tr>
<td class="org-right">655</td>
<td class="org-right">22</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-right">Chr</td>
</tr>

<tr>
<td class="org-right">412</td>
<td class="org-right">X</td>
</tr>
</tbody>
</table>

<p>
Okay, so now we've got a map file with the maximum number of informative chrX markers (412)
</p>
</div>
</div>

<div id="outline-container-orgc47dde6" class="outline-4">
<h4 id="orgc47dde6">Run the Linkage</h4>
<div class="outline-text-4" id="text-orgc47dde6">
<p>
And now we pray&#x2026;
</p>
</div>

<div id="outline-container-org4234594" class="outline-5">
<h5 id="org4234594">Gender error in 2024 (male by testing, female in ped)</h5>
<div class="outline-text-5" id="text-org4234594">
<p>
First error is that individual <code>2024</code> is apparently male according to <code>pedcheck</code> and not a female as specified in the pedfile.
</p>

<p>
Given that this is the first time we have encountered this error, I will go on a hunch and say that the proportion of hemizygous XY vs heterozygous XX shifted towards the hemi side due to the low resolution.
</p>

<p>
There is nothing I can do here except a) Re-run the linkage with 2024 as a man (in which case I will need to check for consistency again), or ignore pedcheck. We will ignore pedcheck for now.
</p>
</div>
</div>

<div id="outline-container-org94ae85e" class="outline-5">
<h5 id="org94ae85e">Ignoring Pedcheck</h5>
<div class="outline-text-5" id="text-org94ae85e">
<p>
To do this I commented out <code>&amp;CompareSampleIDs</code> and <code>&amp;CheckGender</code> in <code>/usr/local/bin/auto/stage1.pl</code>.
</p>

<p>
That did not have the desired effect (it still kept checking files), so I disabled <code>auto_stage1.sh</code> from <code>simple_run.sh</code>
</p>
</div>
</div>

<div id="outline-container-org9440a02" class="outline-5">
<h5 id="org9440a02">Success?</h5>
<div class="outline-text-5" id="text-org9440a02">
<p>
It ran! Allegro ran without any inconsistent marker errors, and there is a definite peak on the X-chromosome compared to the others.
</p>

<p>
There is no GRR check, but this is because I had to disable pedcheck due to the inflated hemi:hetero ratio from the lack of enough X markers.
</p>
</div>
</div>
</div>
</div>
</div>


<div id="outline-container-org9bd76cc" class="outline-2">
<h2 id="org9bd76cc">Thoughts so far</h2>
<div class="outline-text-2" id="text-org9bd76cc">
<p>
This is the most difficult linkage project I've ever worked on. The plots, haplotypes, and other results are in the folder accompanying this report.
</p>

<p>
Of the 5062 chromosome X markers in genotypes, only 412 chromosome X markers were deemed informative and consistent, in order to make it into the final analysis (91% of X markers were removed&#x2026;)
</p>

<p>
As a result, the linkage peak in the X chromosome could not be "flattened", and the linkage peak crosses the centromere which causes a gap.
</p>


<div id="org0c3a61e" class="figure">
<p><img src="./imgs/summary.png" alt="summary.png" />
</p>
<p><span class="figure-number">Figure 3: </span>(Top) Allegro and (Bottom) GeneHunter for (Left) entire genome and (Right) only chromosome X.</p>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 3:</span> Messner Output</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Program</th>
<th scope="col" class="org-left">Chrom</th>
<th scope="col" class="org-left">Position</th>
<th scope="col" class="org-left">Markers</th>
<th scope="col" class="org-right">LOD</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Allegro</td>
<td class="org-left">chrX</td>
<td class="org-left">43633740 - 82959062</td>
<td class="org-left">rs10521432 - rs7060133</td>
<td class="org-right">1.43</td>
</tr>

<tr>
<td class="org-left">Genehunter</td>
<td class="org-left">chrX</td>
<td class="org-left">44452840 - 67707597</td>
<td class="org-left">rs2093534 - rs5919577</td>
<td class="org-right">2.05</td>
</tr>
</tbody>
</table>
</div>


<div id="outline-container-orga3a9acc" class="outline-3">
<h3 id="orga3a9acc">Why so few markers?</h3>
<div class="outline-text-3" id="text-orga3a9acc">
<p>
The reasoning behind the removal of so many chromosome X markers are <a href="#orgc915200">outlined</a> in <a href="#org7e0d2f3">the</a> previous <a href="#org827fd0b">sections</a>, but to summarize:
</p>

<ol class="org-ol">
<li>Allegro kept throwing "inconsistent marker" errors for the
chromosome X markers.</li>
<li><p>
Examining <a href="#org5b12ec4">these</a> markers <a href="#orged25402">individually</a> in the genotypes file
showed these markers really <b>did</b> have inconsistent genotypes
on the assumption that:
</p>

<ol class="org-ol">
<li>No recombination occurs on the Y chromosome.</li>
<li>Brothers must share one allele</li>
<li>Fathers and Sons must share one allele</li>
</ol>

<p>
By <a href="#orgc939c72">writing a parser</a> which flagged the inconsistent markers which violated these
above assumptions, approximately 2000 chromosome X markers were removed
and then snpbutcher further removed all but 313 informative markers.
</p></li>

<li>To improve the number of chromosome X markers in the analysis, snpbutcher
was instructed to keep every informative X marker it can by ignoring any
spacing constraints. This boosted the number of informative X markers
from 313 to 412.</li>
</ol>


<p>
Due to the low resolution, gendercheck and GRR had to be disabled in this run for the analysis to run, otherwise it claimed that <a href="#org4234594">individual 2024 was actually male</a>, and not female. This error never occured in any previous run with higher number of markers, so I assumed the stated gender was correct.
</p>

<p>
The GRR in this report is actually from a previous run with a higher number of markers. I noticed that certain <code>father-son</code> relationships (yellow dots) <a href="#orgab8803f">clustered separately</a> from other parental relationships (other yellow dots), but I assumed that this to be expected.
</p>
</div>
</div>


<div id="outline-container-org7333186" class="outline-3">
<h3 id="org7333186">Was it just one or two individuals messing up the analysis?</h3>
<div class="outline-text-3" id="text-org7333186">
<p>
I explored that idea in Table <a href="#org8706e84">1</a> which shows the distribution of chromosome X markers removed based on the individuals who flagged the marker. Mostly it was:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 4:</span> Number of X markers removed as flagged by specific relationships (here only father-son shown)</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Relationship</th>
<th scope="col" class="org-right">ID1</th>
<th scope="col" class="org-right">ID2</th>
<th scope="col" class="org-right">X Removed</th>
<th scope="col" class="org-right">Family</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">father-son</td>
<td class="org-right">57</td>
<td class="org-right">97</td>
<td class="org-right">1155</td>
<td class="org-right">1181</td>
</tr>

<tr>
<td class="org-left">father-son</td>
<td class="org-right">2029</td>
<td class="org-right">2025</td>
<td class="org-right">1227</td>
<td class="org-right">1183</td>
</tr>

<tr>
<td class="org-left">father-son</td>
<td class="org-right">2033</td>
<td class="org-right">2036</td>
<td class="org-right">1200</td>
<td class="org-right">1183</td>
</tr>

<tr>
<td class="org-left">father-son</td>
<td class="org-right">2033</td>
<td class="org-right">2035</td>
<td class="org-right">1184</td>
<td class="org-right">1183</td>
</tr>
</tbody>
</table>


<p>
So there is some bias from family 1183, but the amount of chromosome X markers removed based on the father-son pairs are pretty uniform. All other father-son relations appear to be between ungenotyped and genotyped individuals, so what you see above are all the genotyped father-son pairs.
</p>
</div>
</div>

<div id="outline-container-org71542a5" class="outline-3">
<h3 id="org71542a5">Perhaps too stringent with the filtering?</h3>
<div class="outline-text-3" id="text-org71542a5">
<p>
You tell me. Included in the report is the file <a href="inconsistent2.X.tsv">inconsistent2.X.tsv</a> which contains the raw data which that the above table was generated from. The columns of the file are: marker, relationship of the individuals, the individual IDs, and their alleles. Please feel free to inspect these alleles yourself in case you think my filtering was too stringent.
</p>
</div>
</div>


<div id="outline-container-orgf0c720a" class="outline-3">
<h3 id="orgf0c720a">How to proceed next</h3>
<div class="outline-text-3" id="text-orgf0c720a">
<p>
Some options we could explore:
</p>
</div>

<div id="outline-container-orgccd194d" class="outline-5">
<h5 id="orgccd194d">Option 1: Assume chromosome X genotypes are correct and Allegro is wrong.</h5>
<div class="outline-text-5" id="text-orgccd194d">
<p>
If by some magic it actually makes sense for a father to have alleles "AA" and a son to have "BB" on the X chromosome, then we cannot trust Allegro.
</p>

<p>
I would then re-run the analysis only to target genehunter, which I believe was updated much later than allegro and is still used. This might give fewer inconsistent markers, and maybe I would not have to filter so much to get the analysis to work.
</p>
</div>
</div>

<div id="outline-container-orgadfd17f" class="outline-5">
<h5 id="orgadfd17f">Option 2: Change the Gender of individual 2024 to male</h5>
<div class="outline-text-5" id="text-orgadfd17f">
<p>
In the pedigree this individual is labelled as female and, until I reduced the number of X markers drastically, did not flag any warnings in previous runs. If we change them to male, then I must regenerate all, but like this will not improve the linkage because it would be another father-son relation (instead of father-daughter) that would be screened for consistency. This can only decrease the number of X markers left in the analysis.
</p>
</div>
</div>




<div id="outline-container-org4fefd8b" class="outline-5">
<h5 id="org4fefd8b">Option 3: Reduce SNPButcher impact on the genotypes</h5>
<div class="outline-text-5" id="text-org4fefd8b">
<p>
We lost most of our genotypes from SNPbutcher. What if we modify it so that instead of kicking out markers with any NC calls, it only kicks out the markers with only a few calls of NC. <b>Edit:</b> No, the way informative markers are decided is <b>NOT</b> by the number of NC calls, but actually whether or not all genotypes have the same call across all individuals.
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-orgbf76ba4" class="outline-2">
<h2 id="orgbf76ba4">Linkage Analysis (Attempt 6)</h2>
<div class="outline-text-2" id="text-orgbf76ba4">
<p>
Let's use all the X markers we can, informative or not. We will use the same genotypes file from the last run which has the inconsistent markers removed. 
</p>

<p>
In this run for chromosome X we will have : consistent X markers + uninformative X markers
</p>
</div>

<div id="outline-container-org13271c3" class="outline-4">
<h4 id="org13271c3">Number of Possible X Markers</h4>
<div class="outline-text-4" id="text-org13271c3">
<div class="org-src-container">
<pre class="src src-elisp">(let ((uninf nil)
      (isX 0))
  (with-current-buffer (find-file-noselect "genotypes")
    (goto-char (point-min))
    (while (not (eobp))
      (let* ((tokens (split-string (buffer-substring-no-properties (point)
                                                                   (progn (forward-line 1) (point)))))
             (gts (cdr tokens))
             (marker (car tokens))
             (gtuniq (-uniq gts)))
        (when (gethash marker chromX)
          (setq isX (1+ isX))
          (if (eq (length gtuniq) 1)
              (push marker uninf))))))
  (cons (length uninf) isX))
</pre>
</div>

<pre class="example">
(439 . 925)
</pre>


<p>
There are <code>925</code> chromosome X markers in the genotypes of which <code>439</code> are completely uninformative (all have the same call). We will use all 925.
</p>
</div>
</div>

<div id="outline-container-orgba64c76" class="outline-4">
<h4 id="orgba64c76">Process Files</h4>
<div class="outline-text-4" id="text-orgba64c76">
<div class="org-src-container">
<pre class="src src-bash">mkdir -p 06_fullX
cp -v 05_noinconsistentX2/{map.all.txt,pedfile.pro,genotypes} 06_fullX/
cp -v 01_initial/maf.txt 06_fullX/
</pre>
</div>

<pre class="example">
'05_noinconsistentX2/map.all.txt' -&gt; '06_fullX/map.all.txt'
'05_noinconsistentX2/pedfile.pro' -&gt; '06_fullX/pedfile.pro'
'05_noinconsistentX2/genotypes' -&gt; '06_fullX/genotypes'
'01_initial/maf.txt' -&gt; '06_fullX/maf.txt'
</pre>



<div class="org-src-container">
<pre class="src src-sh">snpbutcher2.py map.all.txt maf.txt genotypes -u -z -nh &gt; map.txt
cat map.txt | grep "^X" &gt; Xonly.txt
wc -l Xonly.txt
</pre>
</div>

<pre class="example">
1436 Xonly.txt
</pre>


<p>
Now we will combine this X-only map with the informative autosomal map from the previous run
</p>

<div class="org-src-container">
<pre class="src src-sh">cat ../05_noinconsistentX2/only.autosomes.half Xonly.txt &gt; map.txt
awk '{print $1}' map.txt | sort | uniq -c
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<tbody>
<tr>
<td class="org-right">2802</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-right">2858</td>
<td class="org-right">2</td>
</tr>

<tr>
<td class="org-right">2419</td>
<td class="org-right">3</td>
</tr>

<tr>
<td class="org-right">2260</td>
<td class="org-right">4</td>
</tr>

<tr>
<td class="org-right">2315</td>
<td class="org-right">5</td>
</tr>

<tr>
<td class="org-right">2146</td>
<td class="org-right">6</td>
</tr>

<tr>
<td class="org-right">2030</td>
<td class="org-right">7</td>
</tr>

<tr>
<td class="org-right">1871</td>
<td class="org-right">8</td>
</tr>

<tr>
<td class="org-right">1672</td>
<td class="org-right">9</td>
</tr>

<tr>
<td class="org-right">1847</td>
<td class="org-right">10</td>
</tr>

<tr>
<td class="org-right">1692</td>
<td class="org-right">11</td>
</tr>

<tr>
<td class="org-right">1772</td>
<td class="org-right">12</td>
</tr>

<tr>
<td class="org-right">1361</td>
<td class="org-right">13</td>
</tr>

<tr>
<td class="org-right">1225</td>
<td class="org-right">14</td>
</tr>

<tr>
<td class="org-right">1238</td>
<td class="org-right">15</td>
</tr>

<tr>
<td class="org-right">1292</td>
<td class="org-right">16</td>
</tr>

<tr>
<td class="org-right">1252</td>
<td class="org-right">17</td>
</tr>

<tr>
<td class="org-right">1231</td>
<td class="org-right">18</td>
</tr>

<tr>
<td class="org-right">870</td>
<td class="org-right">19</td>
</tr>

<tr>
<td class="org-right">1133</td>
<td class="org-right">20</td>
</tr>

<tr>
<td class="org-right">720</td>
<td class="org-right">21</td>
</tr>

<tr>
<td class="org-right">655</td>
<td class="org-right">22</td>
</tr>

<tr>
<td class="org-right">1436</td>
<td class="org-right">X</td>
</tr>
</tbody>
</table>

<p>
1436 X chromosome markers
</p>
</div>
</div>

<div id="outline-container-org2085841" class="outline-4">
<h4 id="org2085841">Run the pipeline</h4>
<div class="outline-text-4" id="text-org2085841">
<p>
Let's see. Well, it errored out with the gender error again for 2024&#x2026; but that is to be expected since the inconsistent markers are not being used.
Let's disable pedcheck again&#x2026;
</p>

<p>
So far we seem to see a tighter peak concentrated at that region.
</p>


<div id="orgdaf092b" class="figure">
<p><img src="./imgs/summary2.png" alt="summary2.png" />
</p>
<p><span class="figure-number">Figure 4: </span>(Top) Allegro and (Bottom) GeneHunter for (Left) entire genome and (Right) only chromosome X.</p>
</div>


<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 5:</span> Messner Output</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Program</th>
<th scope="col" class="org-left">Chrom</th>
<th scope="col" class="org-left">Position</th>
<th scope="col" class="org-left">Markers</th>
<th scope="col" class="org-right">LOD</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Allegro</td>
<td class="org-left">chrX</td>
<td class="org-left">43506535 - 84444331</td>
<td class="org-left">rs1181275 - rs12013799</td>
<td class="org-right">2.04</td>
</tr>

<tr>
<td class="org-left">Genehunter</td>
<td class="org-left">chrX</td>
<td class="org-left">44387439 - 58121424</td>
<td class="org-left">rs7051695 - rs6611652</td>
<td class="org-right">2.13</td>
</tr>
</tbody>
</table>


<p>
Given that this peak was generated by including uninformative markers (all <code>AA</code> or <code>AB</code> or <code>BB</code> or <code>NC</code> across samples), I'm not sure how useful this is.
</p>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Mehmet Tekman</p>
<p class="date">Created: 2020-06-26 Fri 12:18</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
